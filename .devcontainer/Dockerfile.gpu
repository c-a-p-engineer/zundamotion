# =========================================================
# CUDA + FFmpeg + Python3.13 環境（Ubuntu 22.04 ベース）
# =========================================================
FROM nvidia/cuda:12.4.1-devel-ubuntu22.04

ENV DEBIAN_FRONTEND=noninteractive

# ---------------------------------------------------------
# 基本ツールの導入
# ---------------------------------------------------------
RUN apt-get update && apt-get install -y \
   curl unzip git \
   && apt-get clean

# ---------------------------------------------------------
# 日本語フォント（IPAゴシック）
#   → 字幕レンダリングや日本語出力に必要
# ---------------------------------------------------------
RUN apt-get update && apt-get install -y \
   fonts-ipafont-gothic \
   && apt-get clean

# ---------------------------------------------------------
# Python 3.13 の導入準備
#   - deadsnakes PPA を追加して最新の 3.13 を取得
#   - build関連パッケージも合わせて導入
# ---------------------------------------------------------
RUN apt-get update && apt-get install -y --no-install-recommends \
   gnupg2 curl software-properties-common \
   && add-apt-repository ppa:deadsnakes/ppa -y \
   && apt-get update \
   && apt-get install -y --no-install-recommends \
   python3.13 python3.13-venv python3.13-dev \
   && apt-get clean

# ---------------------------------------------------------
# pip 導入 & Python 3.13 の仮想環境を作成
#   - get-pip.py は非推奨 → ensurepip を利用
#   - /opt/pyenv を仮想環境のデフォルトに設定
# ---------------------------------------------------------
RUN python3.13 -m ensurepip --upgrade \
   && python3.13 -m pip install --no-cache-dir --upgrade pip setuptools wheel \
   && python3.13 -m venv /opt/pyenv \
   && /opt/pyenv/bin/pip install --no-cache-dir --upgrade pip

ENV PATH="/opt/pyenv/bin:${PATH}"

# ---------------------------------------------------------
# Python パッケージのインストール
#   - requirements.txt にまとめて管理
# ---------------------------------------------------------
COPY requirements.txt .
RUN pip install --upgrade pip \
   && pip install --no-cache-dir -r requirements.txt

# ---------------------------------------------------------
# FFmpeg パッケージのインストール
# ---------------------------------------------------------
RUN apt-get update && apt-get install -y \
   wget \
   xz-utils \
   ffmpeg 

# ---------------------------------------------------------
# ワークスペース設定
# ---------------------------------------------------------
WORKDIR /workspace

# ---------------------------------------------------------
# 動作確認（バージョン表示）
# ---------------------------------------------------------
RUN python3.13 --version && python --version && pip --version
