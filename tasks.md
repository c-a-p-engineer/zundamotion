# 📋 Zundamotion タスクリスト（優先度順・再整理）

本ファイルは、最新ログを踏まえた改善タスクのみを掲載します（完了済みは削除）。

参照ログ（最新→古い順）: `logs/20250910_045352_758.log`, `logs/20250910_041524_580.log`

最新観測サマリ（2025-09-10 実行）:
- 総所要: 187.98s。内訳: AudioPhase ≈? / VideoPhase 153.57s / BGMPhase ≈? / FinalizePhase ≈?（ログ時刻より）。
- NVENCエンコードは利用可（smoke OK）。一方、GPUフィルタは無効: `[Filters] GPU overlay backend=none (cuda=None, opencl_ok=False, scale_only=True, scale_only_smoke_ok=False)`
  - CUDA系フィルタのスモーク失敗/未提供→フィルタ経路はCPUへ統一（NVENCは継続）。
  - OpenCL もスモーク失敗（overlay/scaleとも）→ハイブリッド経路は未解禁。
- AutoTuneにより HWフィルタを `cpu` 固定、`filter_threads=2` 上限、`clip_workers≈3` に調整。
- ConcatCopy は高速（~119MB/s）。明確なボトルネックは引き続き VideoPhase（CPU overlay 支配）。
- 備考: スケーラ最適化（scale_flags）/FPSフィルタ抑制の導入により、VideoPhase は前回 178.45s → 今回 153.57s（約14%短縮）。総所要も 225.38s → 187.98s（約17%短縮）。


## P1（品質向上・高速化）

### 00. FFmpeg を CUDAフィルタ入りビルドへ切替（環境整備）［最優先・要環境対応］
- 背景: 最新ログでは `overlay_cuda/scale_cuda` 不可。GPUフィルタ経路が解禁できずCPU支配。
- 目的: `overlay_cuda` 経路の解禁で VideoPhase を大幅短縮。
- 方針: BtbN の別アーティファクトや自前ビルド（`--enable-cuda-nvcc --enable-libnpp --enable-nonfree`）を採用。DevContainerのフィルタ一覧スナップショットで確認。
- 成果確認: ログに `CUDA filters available: True`、`[Diagnostics] Filter path usage` に `cuda_overlay>0`。

### 01. 新実装の効果検証＆チューニング（VideoPhase短縮）［実装継続・効果確認中］
- 背景: 字幕PNGプリキャッシュ、キャラPNG事前スケール、スケーラ最適化（`video.scale_flags`）、FPSフィルタ抑制（`video.apply_fps_filter`）を導入済み。
- 現状: VideoPhase 178.45s → 153.57s（約14%短縮）、総所要 225.38s → 187.98s（約17%短縮）。
- 目的: 閾値/プリセットの最適化と回帰防止。
- 方針: `precache_min_lines`/`CHAR_ALPHA_THRESHOLD`/`allow_opencl_overlay_in_cpu_mode`/`scene_base_min_lines` を再調整し、`[Diagnostics] Slowest line clips` とともに継続計測。
- 成果確認: VideoPhaseのさらなる短縮（+5〜10%目安）と最遅行の改善。必要に応じ `cache/autotune_hint.json` を更新。

### 02. OpenCL overlay 安定性検証（オプトイン）［実装完了・検証待ち］
- 背景: CPUモードでも OpenCL overlay を許可できるようにしたが、環境差が大きい。
- 目的: 対象環境での安定度/短縮効果を計測し、既定値（false）の是非を判断。
- 方針: `video.allow_opencl_overlay_in_cpu_mode: true` で再計測、失敗時は自動フォールバックを確認。
- 成果確認: `[Diagnostics] Filter path usage` に `opencl_overlay>0`、VideoPhase短縮が確認できること。


## P2（改善・将来・機能追加）

### 01. VOICEVOX 音声合成の並列化（スピーカー単位の上限）
- 背景: 今回ログではAudioPhaseは8%と支配的ではないが、行数が多い脚本で効く改善。
- 目的: スループット向上と安定性（レート制限回避）。
- 方針: `asyncio.Semaphore` による全体/話者別上限、タイムアウト/リトライ調整、並列度統計のログ化。
- 成果確認: 大規模台本での短縮とエラー無増加。

### 01. 口パク（音素/ビセーム）最小実装
- 機能: 音素/ビセーム推定に基づき口形 PNG を時間同期で切替。
- 背景: 現状は最小版（音量しきい値）を実装済。精度向上の余地あり。
- ゴール: 音素ベースで自然な口形遷移。
- 実装案: pyopenjtalk 等で音素列→ビセーム時系列→`face_anim` 注入。
- 確認方法: デバッグ可視化用に mouth state をログ/タイムライン出力。

### 02. フィルター/エフェクトのプリセット
- 機能: ぼかし/ビネット/色調/LUT/ズームパン等を行/シーン単位で適用。
- 背景: 表現力の拡充要望。
- ゴール: 既存スキーマ最小拡張で汎用エフェクト適用。
- 実装案: `line_config.effects[]` を追加し filter_complex に合成。RGBA 無しなら GPU backend を優先。
- 確認方法: 比較用ゴールデン映像と目視/ヒストグラム比較。

### 03. トランジション拡充（テンプレ化）
- 機能: スライド/ワイプ/グリッチ等のテンプレ追加。
- 背景: xfade 以外の需要。
- ゴール: 種類/パラメータ化を `apply_transition` に統合。
- 実装案: 種別ごとに filter_complex を実装、CLI/スキーマから選択。
- 確認方法: サンプル台本で連結動作と境界の音切れ無しを確認。

### 04. カラオケ風字幕
- 機能: 読み上げ進行に合わせてテキストをハイライト。
- 背景: 表現の拡張。
- ゴール: 視認性と同期精度の確保。
- 実装案: 分割 PNG/マスクレイヤ or `subtitles` フィルタ併用。
- 確認方法: 音声とハイライトの誤差 < 100ms。

### 05. ピクチャー・イン・ピクチャー（PIP）
- 機能: 任意の動画/画像を枠付きで重畳表示。
- 背景: 解説/ゲーム実況等の需要。
- ゴール: 角丸/影/枠のオプション提供。
- 実装案: 追加 overlay チェーンと簡易 UI スキーマ。
- 確認方法: 位置/サイズ/枠のオプションが効くこと。

### 06. BGM ビート検出と自動カット合わせ
- 機能: BGM の拍に台詞/カットを寄せる。
- 背景: テンポ感の向上。
- ゴール: 過剰な調整を避けつつ自然な合わせ。
- 実装案: オンセット検出→開始時刻微調整。
- 確認方法: クリック音デバッグとタイムライン比較。

### 07. SRT/WebVTT の入出力
- 機能: 外部字幕のインポート/エクスポート。
- 背景: 互換性確保。
- ゴール: 双方向変換を提供。
- 実装案: `Timeline` 拡張、parser/writer 追加。
- 確認方法: 既存ツールとの相互運用テスト。

### 08. プレビュー高速レンダリングモード
- 機能: 低解像度/低ビットレートでのクイックプレビュー。
- 背景: 繰り返し調整の高速化。
- ゴール: 本番設定に影響を与えずプレビューのみ高速化。
- 実装案: `--preview` で `VideoParams` を縮小、字幕PNGは共通キャッシュ。
- 確認方法: プレビュー所要が大幅短縮されること。

### 09. 背景除去/クロマキー（簡易）
- 機能: 立ち絵/動画の背景透過/色キー除去。
- 背景: グリーンバック素材の活用。
- ゴール: 破綻の少ない単純除去。
- 実装案: `colorkey`/`chromakey`/差分合成の適用。
- 確認方法: 境界ノイズ/色抜けの目視確認。

### 10. キーフレーム的パラメトリックアニメ
- 機能: 位置/スケール/不透明度の時間変化。
- 背景: 表現力向上。
- ゴール: シンプルな指定で自然な動き。
- 実装案: 簡易キーフレーム→補間→ filter_complex 反映。
- 確認方法: モーション軌跡のログ/動画で検証。

### 11. プロジェクトテンプレ/テーマ
- 機能: 構成/スタイルのテンプレ化。
- 背景: セットアップ時間短縮。
- ゴール: 再利用性向上。
- 実装案: `templates/` 整備と CLI スキャフォールド。
- 確認方法: ひな形からの生成が成功すること。

### 12. 吹き出し/ネームプレート（話者UI）
- 機能: キャラ名入りの吹き出し/プレート表示。
- 背景: 話者識別の明確化。
- ゴール: 視認性と読みやすさ向上。
- 実装案: 吹き出しPNGテンプレ＋テキスト合成 or 字幕拡張。
- 確認方法: レイアウト崩れや被りがないこと。

### 13. YAMLスキーマ拡張（assets辞書・字幕スタイルテンプレ）
- 機能: パス直書きを避け、テンプレ/辞書参照を可能に。
- 背景: 冗長性/編集コストの削減。
- ゴール: スキーマの簡素化と可読性向上。
- 実装案: `script_loader` でテンプレ展開・検証を追加。
- 確認方法: 既存・新形式の双方で正しく解決されること。

### 14. 自動ポーズ/句読点ルール
- 機能: 句読点等で自動ポーズを挿入。
- 背景: 自然な発話テンポ。
- ゴール: 過剰/不足のないポーズ。
- 実装案: テキスト整形→無音区間挿入。
- 確認方法: タイムライン/耳での確認。

### 15. サムネ/チャプター自動生成
- 機能: キーシーンの静止画・YouTube チャプターTXT出力。
- 背景: 投稿準備の効率化。
- ゴール: 最小操作で公開可。
- 実装案: `Timeline` から境界抽出→ ffmpeg でサムネ生成。
- 確認方法: 生成物の内容/時刻が妥当であること。
