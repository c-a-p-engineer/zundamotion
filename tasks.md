# 📋 Zundamotion タスクリスト（優先度順）

本ファイルは、現状コード・ログの観察結果に基づく改善タスクと将来機能を、優先度順に整理したものです。

参照ログ: `logs/20250829_173010_825.log`

## P0（必須・最優先）


### 03. 動画結合（-f concat -c copy）の速度検証と入出力最適化

- 背景: 正規化完了（17:33:29）から結合完了（17:34:08）まで ~39s。入力本数が多い場合の I/O が支配的な可能性。
- 対応: 一時リストファイルの配置を `temp_dir` に変更、ストレージI/Oを計測。必要に応じてクリップ数をシーン内で先に `concat` でまとめるなどの段階的結合を導入。
- 検証: 同条件で結合所要が短縮されること（p95 を記録）。

### 04. ログ整形の乱れ修正（観測容易性）

- 背景: `17:30:24,44` のような桁欠落や `[...] omitted` の混入があり、時系列追跡が阻害。
- 対応: tqdm と logger の干渉回避（tqdm.write / logging の混用規約化、QueueHandler化）。ログフォーマッタのミリ秒桁固定。
- 検証: 次回ログで欠落・混入が解消されていること。

## P1（重要・中期）

### 06. `--no-cache` 時の挙動とログ文言の明確化

- 背景: `cache/` に一時ファイルが生成されるため混乱。
- 対応: 一時出力は `temp_dir` に統一し、ログに `Persistent=OFF / Ephemeral=...` を明示。

### 07. 同一素材の重複プローブ抑止（短期メモ化）

- 背景: 同一パス＋同一規格要求への連続 `ffprobe`/比較が発生。
- 対応: プロセス内メモ化（LRU/短期dict）で N 回以内はヒットさせる。

### 08. 字幕クリップ生成のスループット改善

- 背景: PNG生成と合成の並列度が律速になりがち。
- 対応: `clip_workers` の自動最適化、`-filter_threads`/`-filter_complex_threads` の見直し、PNG生成を ProcessPool へ。

### 09. VOICEVOX 音声合成の並列化

- 背景: AudioPhase 27.42s。セリフ数増で直列だと増大。
- 対応: スピーカーID単位での並列化上限を設定し `asyncio.gather` で束ねる。レート制限配慮。

### 10. Insert メディア正規化経路の統一（`normalize_media` へ）

- 背景: Insert だけ旧API経路が混在。
- 対応: すべて `normalize_media` に統一し、HW検出/オプション/フォールバックの一貫性を確保。

### 11. FinalizePhase の `--final-copy-only` をCLIに配線

- 目的: 再エンコードへのフォールバックを抑止した厳格運用を可能に。

### 12. 字幕フォントのフェイルセーフ

- 背景: 指定フォント不在時の失敗回避。
- 対応: 系統フォントへのフォールバックと警告ログ。

## P2（改善・将来・機能追加）

### 13. 口パク（リップシンク）対応（静止立ち絵の口形アニメ）

- 機能: 音声から音素/ビセームを推定し、`characters/*` の口形差分PNGを時間同期で切替。
- 実装案: 軽量な音素推定（pyopenjtalk/phoneme forced alignment 等）→ タイムラインへ mouth=OPEN/CLOSE を注入 → `render_clip` で overlay 切替。
- 代替: 音量包絡で簡易口パク（閾値2段階）。

### 14. フィルター/エフェクトのプリセット

- 機能: ぼかし/ビネット/色調（LUT）/色温度/ズームパン（Ken Burns）などを行/シーン単位で適用。
- 実装案: `line_config.effects[]` を追加し、`filter_complex` を合成。RGBA無しなら CUDA フィルタ採用。

### 15. トランジション拡充とテンプレ（xfade 以外）

- 機能: スライド/ワイプ/グリッチ/ズーム等の遷移。テンプレ名指定で適用。
- 実装案: `apply_transition` の種類を追加し、パラメータ化。

### 16. カラオケ風字幕（逐次ハイライト/グラデ/縁取り強化）

- 機能: 読上げ進行に応じて文字色を流す。影/縁取り/アウトライン色の詳細設定。
- 実装案: 固定PNGではなく分割PNG or drawboxレイヤ併用、または WebVTT → ffmpeg `subtitles` フィルタ採用の選択肢も検討。

### 17. ピクチャー・イン・ピクチャー（PIP）とフェイスカム枠

- 機能: 任意の動画/画像を右下などにPIP表示。枠・角丸・影のオプション。

### 18. BGM ビート検出と自動カット合わせ

- 機能: BGM の拍に台詞/カットを寄せるオプション。
- 実装案: 簡易オンセット検出 → タイムラインの開始時刻を微調整。

### 19. SRT/WebVTT の入出力

- 機能: 外部字幕との互換（インポート/エクスポート）。

### 20. プレビュー高速レンダリングモード

- 機能: 低解像度+低ビットレートでのクイックプレビュー（最終出力前の確認用）。
- 実装案: `--preview` で `VideoParams` を縮小し、字幕PNGキャッシュを使い回し。

### 21. 背景除去/クロマキー（簡易）

- 機能: 立ち絵/挿入動画の背景透過やクロマキー除去。

### 22. キーフレーム的パラメトリックアニメ

- 機能: 位置/スケール/不透明度を時間指定で変化（ズーム/パン/フェード）。

### 23. プロジェクトテンプレ/テーマ

- 機能: 共通の構成/スタイルをテンプレとして使い回し。

## 補足（今回ログでの主な観測ポイント）

- `AudioPhase` は 27.42s（問題小）。
- `VideoPhase` は 205.31s と支配的。17:32:37 台で `scene_bg_intro.mp4` について `[Cache] Normalized miss` が多数発生（重複正規化の疑い）。
- `assets/bg/countdown.mp4` の正規化は NVENC で 9s 程度（正常）。
- シーン結合（-c copy）は成功しているが ~39s 要しており、I/O 最適化余地あり。
