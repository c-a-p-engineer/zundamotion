# 📋 Zundamotion タスクリスト（優先度順・再整理）

本ファイルは、最新ログを踏まえた改善タスクのみを掲載します（完了済みは削除）。

参照ログ: `logs/20250902_022808_840.log`, `logs/20250902_023125_440.log`, `logs/20250831_172922_025.log`

最新観測サマリ（2025-09-02 実行）:
- エンコードは NVENC 利用。字幕PNGや立ち絵で RGBA 合成が発生し CPU overlay 経路が優勢。
- シーン結合は `-f concat -c copy` で成功。I/O スループットは ~80MB/s 程度（ログ追加済み）。
- 主なボトルネックは VideoPhase（CPU overlay）。

## P0（必須・最優先）

### 01. CUDA 非対応時の GPU overlay 代替
- 機能: CUDA フィルタ不可時に `overlay_opencl`/`overlay_vulkan`/`overlay_qsv` 等へ自動切替。
- 背景: ログで CUDA フィルタのスモークテストが失敗（exit 218）し CPU overlay が支配。GPU 合成経路の代替を確保したい。
- ゴール: CUDA 非対応環境でも GPU 合成を維持し、VideoPhase の時間を大幅短縮（目標: CPU overlay 比で 30% 以上短縮）。
- 実装案: 
  - `zundamotion/utils/ffmpeg_utils.py` に `has_opencl_filters/has_vulkan_filters/has_qsv_overlay` と各スモークテスト関数を追加（存在検出→極小フレームでの試行）。
  - `VideoRenderer.create` で CUDA 不可 or `HW_FILTER_MODE=cpu` 時に、上記候補を優先度順に選択して `self.has_cuda_filters` 相当のフラグ群に反映（新規: `gpu_overlay_backend={cuda|opencl|vulkan|qsv|none}`）。
  - `render_clip` のフィルタグラフ生成で `overlay_cuda/scale_cuda` の代わりに各 backend を切替（RGBA サポートの可否に留意。不可なら自動で CPU）。
  - 環境変数/設定 `video.gpu_overlay_backend` で強制指定可。結果を INFO ログ出力。
- 確認方法: 
  - ログに `[Filters] GPU overlay backend=opencl` 等が出力されること。
  - サンプル台本で VideoPhase 時間を計測し、CPU overlay より短縮していること。
  - CUDA が使える環境では従来通り CUDA を優先、使えない環境で他 backend に自動切替されること。

### 02. キャラ画像の事前スケール/キャッシュ（overlay 負荷の削減）
- 機能: 立ち絵 PNG を Pillow で事前スケールして PNG 化、スケール済み画像をキャッシュ再利用。
- 背景: CPU overlay 経路で `scale` がボトルネック。Face 用の事前スケールは導入済みだが、キャラ全体には未適用。
- ゴール: 立ち絵 overlay の filter_complex から `scale` を排除し合成のみへ縮退（VideoPhase p95 を短縮）。
- 実装案:
  - `zundamotion/components/char_overlay_cache.py`（新規）: `get_scaled_overlay(path: Path, scale: float, alpha_thr: int=128)` を提供。内部は Pillow でリサイズ+α門値処理、CacheManager 経由で永続/ephemeral キャッシュ。
  - `VideoRenderer.render_clip` のキャラ処理で、既存の `scale` フィルタを `format=rgba` のみに置換（pre-scaled 入力を使用）。
  - 既存 `FaceOverlayCache` を流用/統合して重複実装を回避。環境変数 `CHAR_CACHE_DISABLE=1` で無効化可能。
- 確認方法:
  - ログに `CharOverlayCache hit/miss` が出力され、2回目以降は hit が増えること。
  - FFmpeg の `filter_complex` からキャラの `scale=...` が消えていること（DEBUG ログで確認）。
  - 処理時間・CPU 使用率が低下すること（同一台本の比較）。

### 03. AutoTune の永続化と早期バックオフ
- 機能: AutoTune 結果（CPU overlay 比率など）をヒントとして永続化し、次回起動時に早期適用。
- 背景: 現状は先頭 N クリップの計測後にバックオフ。毎回のウォームアップ時間が発生。
- ゴール: 次回以降の初期クリップから適切な `HW_FILTER_MODE`/スレッド上限/並列度を適用し、無駄な試行を削減。
- 実装案:
  - `cache/autotune_hint.json`（または `logs/` 配下）に `{cpu_ratio, decided_mode, clip_workers, ts, ffmpeg_ver, gpu_name}` を保存（TTL/バージョン付与）。
  - `VideoPhase.create` で読み込み、条件一致時に `set_hw_filter_mode` と `clip_workers` を先行設定。適用結果を INFO ログ出力。
  - 不一致（GPU/FFmpeg/解像度変更等）の場合は無効化し、再学習して更新。
- 確認方法:
  - 2回目以降の実行ログで `[AutoTune] Loaded hint ...` と早期適用の出力があること。
  - 先頭 N クリップの計測ログが抑制され、全体時間が短縮されること。

## P1（重要・中期）

### 01. VOICEVOX 音声合成の並列化（スピーカー単位の上限）
- 機能: スピーカー単位/全体の同時実行数を制御しつつ、音声合成を非同期並列化。
- 背景: セリフ数が増えるほど直列処理では遅延が大きくなる。エンジン側レート制限も考慮が必要。
- ゴール: AudioPhase のスループット向上（目標: 行数 n に対して O(n)→O(n/k)）。品質・順序は維持。
- 実装案:
  - `pipeline_phases/audio_phase.py` で `asyncio.Semaphore`（全体）と `dict[speaker]->Semaphore`（スピーカー別）を導入。
  - `voicevox_client` のリトライ/タイムアウトを調整。設定 `voice.max_concurrency`, `voice.max_per_speaker` を追加。
  - ログに並列度・待ち時間の統計を出力して可視化。
- 確認方法:
  - 既存サンプル台本で AudioPhase 時間が短縮されること。HTTP 429/5xx が発生しないこと。
  - 出力のファイル数・順序・内容が直列処理と一致すること。

### 02. FinalizePhase の `--final-copy-only` CLI 配線
- 機能: `-c copy` 失敗時にフォールバック再エンコードを禁止してエラー終了する CLI オプションを提供。
- 背景: 厳格な運用（再エンコード禁止）や診断のため、明示的に失敗させたいニーズあり。
- ゴール: `--final-copy-only` 指定時、パラメータ不一致や concat 失敗で即エラー化（非指定時は従来通りフォールバック）。
- 実装案:
  - `main.py` に `--final-copy-only` を追加 → `run_generation` → `GenerationPipeline` → `FinalizePhase(final_copy_only=True)` まで配線。
  - `AI_README.md`/`README.md` の CLI オプション表を更新。
- 確認方法:
  - 人為的にパラメータ不一致のファイルを混在させ、`--final-copy-only` でエラー終了することを確認。
  - 非指定時は従来通りフォールバックで完了することを確認。

### 03. 字幕フォントのフェイルセーフ
- 機能: 指定フォント不在時、システム系統フォントへ自動フォールバックし警告ログを出す。
- 背景: 端末差により書体が存在しないケースで失敗する可能性。
- ゴール: フォント不在でもレンダリングを継続。既定スタイルの視認性を確保。
- 実装案:
  - `components/subtitle_png.py` のフォント解決にフォールバックチェーンを追加（config → 環境変数 → OS 既定）。
  - フォールバック発生時に INFO/Warning を記録し、解決済みパスをログ出力。
- 確認方法:
  - 既定フォントをあえて存在しない値にして実行、フォールバックが働き PNG が生成されることを確認。
  - ログに候補/選定結果が出力されること。

### 04. 字幕クリップ生成のスループット改善
- 機能: 字幕 PNG 生成を別プロセス化/先行生成し、VideoPhase の待ちを低減。
- 背景: 字幕 PNG 生成レイテンシのばらつきが存在。行数が多いとパイプライン全体の足を引っ張る。
- ゴール: 字幕 PNG 生成の p95 < 100ms、VideoPhase 待機時間の縮減。
- 実装案:
  - `SubtitlePNGRenderer` にプロセスプール実行器を追加し、行一覧から先行生成（オプション `--precache-subtitles`）。
  - `clip_workers` と `-filter_threads` のバランスを調整（過剰並列を抑止）。
- 確認方法:
  - ログに生成時間統計を出し、p95 が改善していることを確認。
  - `--precache-subtitles` の有無で VideoPhase 所要が短縮することを確認。

## P2（改善・将来・機能追加）

### 01. 口パク（音素/ビセーム）最小実装
- 機能: 音素/ビセーム推定に基づき口形 PNG を時間同期で切替。
- 背景: 現状は最小版（音量しきい値）を実装済。精度向上の余地あり。
- ゴール: 音素ベースで自然な口形遷移。
- 実装案: pyopenjtalk 等で音素列→ビセーム時系列→`face_anim` 注入。
- 確認方法: デバッグ可視化用に mouth state をログ/タイムライン出力。

### 02. フィルター/エフェクトのプリセット
- 機能: ぼかし/ビネット/色調/LUT/ズームパン等を行/シーン単位で適用。
- 背景: 表現力の拡充要望。
- ゴール: 既存スキーマ最小拡張で汎用エフェクト適用。
- 実装案: `line_config.effects[]` を追加し filter_complex に合成。RGBA 無しなら GPU backend を優先。
- 確認方法: 比較用ゴールデン映像と目視/ヒストグラム比較。

### 03. トランジション拡充（テンプレ化）
- 機能: スライド/ワイプ/グリッチ等のテンプレ追加。
- 背景: xfade 以外の需要。
- ゴール: 種類/パラメータ化を `apply_transition` に統合。
- 実装案: 種別ごとに filter_complex を実装、CLI/スキーマから選択。
- 確認方法: サンプル台本で連結動作と境界の音切れ無しを確認。

### 04. カラオケ風字幕
- 機能: 読み上げ進行に合わせてテキストをハイライト。
- 背景: 表現の拡張。
- ゴール: 視認性と同期精度の確保。
- 実装案: 分割 PNG/マスクレイヤ or `subtitles` フィルタ併用。
- 確認方法: 音声とハイライトの誤差 < 100ms。

### 05. ピクチャー・イン・ピクチャー（PIP）
- 機能: 任意の動画/画像を枠付きで重畳表示。
- 背景: 解説/ゲーム実況等の需要。
- ゴール: 角丸/影/枠のオプション提供。
- 実装案: 追加 overlay チェーンと簡易 UI スキーマ。
- 確認方法: 位置/サイズ/枠のオプションが効くこと。

### 06. BGM ビート検出と自動カット合わせ
- 機能: BGM の拍に台詞/カットを寄せる。
- 背景: テンポ感の向上。
- ゴール: 過剰な調整を避けつつ自然な合わせ。
- 実装案: オンセット検出→開始時刻微調整。
- 確認方法: クリック音デバッグとタイムライン比較。

### 07. SRT/WebVTT の入出力
- 機能: 外部字幕のインポート/エクスポート。
- 背景: 互換性確保。
- ゴール: 双方向変換を提供。
- 実装案: `Timeline` 拡張、parser/writer 追加。
- 確認方法: 既存ツールとの相互運用テスト。

### 08. プレビュー高速レンダリングモード
- 機能: 低解像度/低ビットレートでのクイックプレビュー。
- 背景: 繰り返し調整の高速化。
- ゴール: 本番設定に影響を与えずプレビューのみ高速化。
- 実装案: `--preview` で `VideoParams` を縮小、字幕PNGは共通キャッシュ。
- 確認方法: プレビュー所要が大幅短縮されること。

### 09. 背景除去/クロマキー（簡易）
- 機能: 立ち絵/動画の背景透過/色キー除去。
- 背景: グリーンバック素材の活用。
- ゴール: 破綻の少ない単純除去。
- 実装案: `colorkey`/`chromakey`/差分合成の適用。
- 確認方法: 境界ノイズ/色抜けの目視確認。

### 10. キーフレーム的パラメトリックアニメ
- 機能: 位置/スケール/不透明度の時間変化。
- 背景: 表現力向上。
- ゴール: シンプルな指定で自然な動き。
- 実装案: 簡易キーフレーム→補間→ filter_complex 反映。
- 確認方法: モーション軌跡のログ/動画で検証。

### 11. プロジェクトテンプレ/テーマ
- 機能: 構成/スタイルのテンプレ化。
- 背景: セットアップ時間短縮。
- ゴール: 再利用性向上。
- 実装案: `templates/` 整備と CLI スキャフォールド。
- 確認方法: ひな形からの生成が成功すること。

### 12. 吹き出し/ネームプレート（話者UI）
- 機能: キャラ名入りの吹き出し/プレート表示。
- 背景: 話者識別の明確化。
- ゴール: 視認性と読みやすさ向上。
- 実装案: 吹き出しPNGテンプレ＋テキスト合成 or 字幕拡張。
- 確認方法: レイアウト崩れや被りがないこと。

### 13. YAMLスキーマ拡張（assets辞書・字幕スタイルテンプレ）
- 機能: パス直書きを避け、テンプレ/辞書参照を可能に。
- 背景: 冗長性/編集コストの削減。
- ゴール: スキーマの簡素化と可読性向上。
- 実装案: `script_loader` でテンプレ展開・検証を追加。
- 確認方法: 既存・新形式の双方で正しく解決されること。

### 14. 自動ポーズ/句読点ルール
- 機能: 句読点等で自動ポーズを挿入。
- 背景: 自然な発話テンポ。
- ゴール: 過剰/不足のないポーズ。
- 実装案: テキスト整形→無音区間挿入。
- 確認方法: タイムライン/耳での確認。

### 15. サムネ/チャプター自動生成
- 機能: キーシーンの静止画・YouTube チャプターTXT出力。
- 背景: 投稿準備の効率化。
- ゴール: 最小操作で公開可。
- 実装案: `Timeline` から境界抽出→ ffmpeg でサムネ生成。
- 確認方法: 生成物の内容/時刻が妥当であること。
