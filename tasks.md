承知。重複/表現ブレを統合し、番号を振り直して整形した。
（同義項目はマージ済み：例「copy concat」「入力パラメータ統一」「ジョブ並列化」「ベンチ/メトリクス」「音声統一」など）

# 📋 Zundamotion 開発タスクリスト（統合版）

## P0（必須・即効）

### 01. `-threads 1` 撤廃＋フィルタ並列

* **詳細**: ffmpegの`-threads 1`を除去し、自動並列化。`-filter_threads`等でフィルタ並列も有効化。
* **背景**: すべて単スレでCPUフィルタがボトルネック。
* **ゴール**: 平均 `speed` を ≥1.2×。
* **実装イメージ**: 共通オプションから削除し `-threads 0 -filter_threads $(nproc) -filter_complex_threads $(nproc)` を既定化。

---

### 02. 出力解像度/アスペクトの明示指定（YAML/CLI）

* **詳細**: 出力解像度・比率を `meta` とCLIで指定、全オーバーレイ配置と字幕サイズを自動調整。
* **背景**: 16:9固定でShorts等に非対応。
* **ゴール**: 9:16/1:1含む任意解像度で正しいレイアウト生成。
* **実装イメージ**:

  ```yaml
  meta: { resolution: "1080x1920", aspect_ratio: "9:16" }
  ```

  CLI: `--resolution 1080x1920 --aspect-ratio 9:16`

---

### 03. 背景動画Normalizationのキャッシュ

* **詳細**: 正規化済みBGを内容ハッシュで再利用。
* **背景**: 同一BGをシーン毎に再正規化している。
* **ゴール**: intro等の前処理を1回化。
* **実装イメージ**: `cache/normalized_${sha1(src+params)}.mp4` 存在時スキップ。

---

### 04. クリップ出力パラメータ完全統一

* **詳細**: 映像`1920x1080/30fps/yuv420p/Main`等を全クリップで固定。
* **背景**: パラメータ差異が後段の連結を阻害。
* **ゴール**: 再エンコードなしの結合を常態化。
* **実装イメージ**: ビルダーをテンプレ化（`-r 30 -pix_fmt yuv420p -profile:v main`）。

---

### 05. 音声規格の統一（兼：早期標準化）

* **詳細**: `-ar 48000 -ac 2 -c:a aac -b:a 128k`へ統一。TTS直後に規格化。
* **背景**: 24kHz/mono混在でcopy連結不可＆警告多発。
* **ゴール**: 音声での暗黙再エンコード0。
* **実装イメージ**: TTS出力を即規格変換 or 生成時点で48kHz化。

---

### 06. “copy concat” 採用（concatデマルチプレクサ）

* **詳細**: トランジションなしの区間は `-f concat -c copy` で無再エンコード結合。
* **背景**: `filter_complex concat` で毎回再圧縮。
* **ゴール**: 連結時間≒I/O時間。
* **実装イメージ**: `file 'a.mp4'\nfile 'b.mp4'` の `list.txt` を自動生成し結合。

---

### 07. ワンパス `filter_complex` 生成器

* **詳細**: 全クリップ＋BGMを1本の`filter_complex`で`trim/xfade/acrossfade`処理。
* **背景**: フェーズ分割で中間I/Oと再エンコードが増加。
* **ゴール**: Finalize所要を1/2〜1/3。
* **実装イメージ**: 長さからオフセット算出→xfadeチェーン自動生成。

---

### 08. hwaccelの明示と転送最小化

* **詳細**: `-hwaccel cuda -hwaccel_output_format cuda` を共通化、不要な`hwdownload/hwupload`削減。
* **背景**: GPU→CPU往復が過多。
* **ゴール**: 転送オーバーヘッドの低減。
* **実装イメージ**: GPU非対応フィルタ直前のみ`hwdownload`を挿入。

---

### 09. NVENC高速プリセット切替

* **詳細**: `-preset p1〜p3`等の高速側を選択し、品質は`-cq`で制御。
* **背景**: `-preset fast`固定で最速域を使えていない。
* **ゴール**: 純粋なエンコード時間の短縮。
* **実装イメージ**: `--quality {speed|balance|quality}`でプリセット/`cq`をマップ。

---

### 10. ジョブ並列の安全化

* **詳細**: 同時実行数Nを制御しNVENCセッション/CPU負荷を監視。
* **背景**: `Using 1 specified jobs`で並列余地あり。
* **ゴール**: 壁時計時間の短縮（GPU使用率≈80%）。
* **実装イメージ**: `--jobs N`＋ワーカーキュー、失敗時リトライ。

---

### 11. BGM適用と最終出力の統合

* **詳細**: 可能ケースではBGMミックスをFinalizeの`filter_complex`に統合。
* **背景**: 中間書き出しが1回余分。
* **ゴール**: 中間I/O削減。
* **実装イメージ**: `amix/volume/afade` を最終チェーンに合流。

---

### 12. ベンチ/メトリクス出力

* **詳細**: フェーズ別時間・`speed=fps`を集計しCSV/MDへ。
* **背景**: 体感評価で回帰検出が困難。
* **ゴール**: 変更効果の定量監視。
* **実装イメージ**: ログ正規表現→`perf/YYYYMMDD.csv`、しきい値超過で警告。

---

## P1（中規模：負荷削減＆表現力）

### 13. 字幕の事前レンダ（PNG）

* **詳細**: `drawtext`を廃止し透過PNGで`overlay`。
* **背景**: `drawtext`はCPUコスト大。
* **ゴール**: クリップ`speed` ≥1.4×。
* **実装イメージ**: Pillowで半透明ボックス込み画像→`[bg][text]overlay`。

---

### 14. 立ち絵の事前スケール

* **詳細**: 使用倍率で前処理し合成時は1:1。
* **背景**: 毎フレーム`scale`が無駄。
* **ゴール**: フィルタグラフを軽量化。
* **実装イメージ**: 0.8x/1.0x等の派生PNGを用意。

---

### 15. 静的レイヤーの事前合成＋静止レンダモード

* **詳細**: 背景＋立ち絵をPNGに前合成し、`-loop 1`で動画化するモードを追加。
* **背景**: 不変要素にも毎フレーム`overlay`。
* **ゴール**: 合成コストほぼゼロ。
* **実装イメージ**: `mode=static`時は`filter_complex`未使用でマップのみ。

---

### 16. 部分再エンコード（トランジション領域限定）

* **詳細**: 本編は`-c copy`、クロスフェード部分のみ再エンコード。
* **背景**: 長尺で全面再圧縮は非効率。
* **ゴール**: 時間増加をリニア抑制。
* **実装イメージ**: A | Trans(A→B) | B の3分割＋concat demuxer。

---

### 17. トランジション結果のキャッシュ

* **詳細**: `(prev,next,type,duration,codec)`でキー化。
* **背景**: 同構成の再レンダが発生。
* **ゴール**: 同一並びで即時スキップ。
* **実装イメージ**: メタJSON＋生成物を`cache/transitions/`に保存。

---

### 18. パラメータ/テンプレートの一本化

* **詳細**: `VideoParams/AudioParams`をデータクラス化し全所で参照。
* **背景**: クリップごとの差異で事故る。
* **ゴール**: ドリフト防止・連結失敗ゼロ。
* **実装イメージ**: コマンドビルダーの単一実装に集約。

---

### 19. 素材リゾルバ

* **詳細**: 実行前に全アセットの存在チェック。
* **背景**: 処理途中の「ファイルなし」中断を防ぐ。
* **ゴール**: 実行失敗の早期検知。
* **実装イメージ**: `AssetResolver`で走査→`logger.warning`。

---

### 20. SE相対トリガー

* **詳細**: `line_start/line_end`基準の相対時刻でSE発火。
* **背景**: 固定秒だと合わせ込みが煩雑。
* **ゴール**: 直感的なSE配置。
* **実装イメージ**: `at: line_end - 0.2s` を絶対時間に解決→`adelay/atrim`。

---

### 21. シナリオ記法（二段構え）

* **詳細**: シンプル記法＋詳細記法を併存。
* **背景**: 初心者/上級者の両立。
* **ゴール**: 書きやすさと表現力を両立。
* **実装イメージ**: `script_loader`でデフォルト適用＆詳細項目を尊重。

---

### 22. 複数キャラ表示＆プリセットレイアウト

* **詳細**: `left/right/center/...`等の抽象位置を解像度に基づき座標化。
* **背景**: 1キャラ前提で表現が限定的。
* **ゴール**: 掛け合い/ワイプを容易化。
* **実装イメージ**: 位置プリセット辞書→`overlay`座標に変換。

---

### 23. キャラ入退場アニメ

* **詳細**: `slide_in/fade/zoom`等をYAML指定。
* **背景**: 静止表示だと単調。
* **ゴール**: 視覚的リッチ化。
* **実装イメージ**: `fade/zoompan/setpts`等の組合せをプリセット化。

---

### 24. プロファイル切替（Speed/Balanced/Quality）

* **詳細**: `--profile`でfps/preset/cq/threads/jobsを一括切替。
* **背景**: デバッグ/本番で要件が違う。
* **ゴール**: 運用切替の即応性。
* **実装イメージ**: `profiles.yaml`→内部マッピング。

---

### 25. 失敗時フォールバック

* **詳細**: NVENC失敗時はlibx264 `-preset veryfast`へ自動降格。
* **背景**: セッション枯渇等で停止しがち。
* **ゴール**: 中断回避と再現性。
* **実装イメージ**: コマンド再試行と原因ログ/再現コマンド出力。

---

## P2（環境・拡張）

### 26. FFmpegのCUDA/NPP対応ビルド

* **詳細**: `scale_npp/overlay_cuda`等が使えるビルドへ更新。
* **背景**: CPUフィルタでGPUが遊ぶ。
* **ゴール**: フィルタをGPU側に寄せる。
* **実装イメージ**: `--enable-cuda-nvcc --enable-libnpp --enable-nonfree`、`ffmpeg -filters`で検証。

---

### 27. GPUフィルタグラフ実装

* **詳細**: `scale→scale_npp`、`overlay→overlay_cuda`に置換。
* **背景**: デコードのみGPU、フィルタがCPU。
* **ゴール**: 速度2×も視野。
* **実装イメージ**: `-hwaccel_output_format cuda`＋必要箇所のみ`hwdownload`。

---

### 28. キャッシュキー/ダーティトラッキング

* **詳細**: 入力/設定/FFmpeg版をハッシュ管理し自動無効化。
* **背景**: 古いキャッシュ混入。
* **ゴール**: キャッシュ整合性の担保。
* **実装イメージ**: `key = sha1(params+paths+buildconf)`、差分で再生成。

---

### 29. DevContainerのGPU自動検知

* **詳細**: `NVIDIA_VISIBLE_DEVICES`等で自動プロファイル切替。
* **背景**: 初期セットアップの手当不足。
* **ゴール**: すぐ最適経路で実行。
* **実装イメージ**: エントリポイントで検知→環境変数→既定プロファイル変更。

---

### 30. FFmpegバージョン固定と検証

* **詳細**: 特定ビルドに固定し差分をログ。
* **背景**: 環境により速度/挙動が変動。
* **ゴール**: 再現性の担保。
* **実装イメージ**: Dockerfile固定、`ffmpeg -buildconf` をログ出力。

---

### 31. CIベンチ（短尺サンプル）

* **詳細**: PRごとに計測し退行検知。
* **背景**: 性能退行の見落とし。
* **ゴール**: 早期検出。
* **実装イメージ**: Actionsでレンダ→メトリクスをArtifacts/コメントに出力。

---

### 32. ドキュメント整備（高速化ガイド）

* **詳細**: 「速くする設定」「トラブル時チェックリスト」。
* **背景**: 利用者の自助を促進。
* **ゴール**: 導入/運用の摩擦低減。
* **実装イメージ**: `docs/performance.md` にケース別レシピ。

---

### 33. 配布/実行環境整備（PyPI/Docker/CI）

* **詳細**: `pyproject.toml`、`Dockerfile`、CIビルド/配布。
* **背景**: 導入性と再現性の確保。
* **ゴール**: `pip install` & コンテナ実行を容易化。
* **実装イメージ**: GH Actionsでテスト→ビルド→公開。

---

### 34. 構成ログ出力（JSON/CSV）

* **詳細**: 使用素材とタイムラインをJSON/CSVでエクスポート。
* **背景**: 外部分析/デバッグ用に可視化が必要。
* **ゴール**: ツール連携と検証容易化。
* **実装イメージ**: `Timeline.save_as_json(csv=True)` を実装。

---

### 35. Shorts自動リフレーム

* **詳細**: 16:9→9:16への自動変換（位置補正含む）。
* **背景**: 既存横動画の再利用需要。
* **ゴール**: CLI一発でShorts化。
* **実装イメージ**: `--profile yt_shorts`で`crop/pad`＋配置補正。

---

### 36. 拡張トランジション

* **詳細**: `wipe/slide/dissolve`等の追加。
* **背景**: 表現がフェード中心で単調。
* **ゴール**: 視覚バリエーション拡張。
* **実装イメージ**: `Finalize`で`xfade`タイプ切替辞書を実装。

---

### 37. 自動サムネイル生成

* **詳細**: 動画から代表フレーム抽出＋タイトル合成。
* **背景**: 運用作業の削減。
* **ゴール**: 生成と同時にサムネ出力。
* **実装イメージ**: `select=gt(scene,0.4)`＋`drawtext`（またはPNG合成）。

---

### 38. Viseme対応 & VRM連動（長期）

* **詳細**: 音素→口形（2D）→将来はVRMモーション連携。
* **背景**: 静止表示でリップシンクが不自然。
* **ゴール**: 自然な口パクと3D拡張。
* **実装イメージ**: 音素取得→口形マップ→タイムライン駆動、VRMは別モジュール。

---

## 進め方（受け入れ条件の例）

* **推奨順**: P0全完了 → P1: 13/15/16/17 → P2: 26/27/28/31。
* **KPI**:

  * P0完了後：総時間 ≥1.5× 改善、平均 `speed` ≥1.3。
  * P1主要施策後：総時間 ≥2.0×、連結の再エンコード回数 0〜1回。
  * P2(GPU化)後：平均 `speed` ≥2.5、I/O以外のCPUボトルネック解消。
