# 📋 Zundamotion タスクリスト（優先度順）

本ファイルは、現状コード・ログの観察結果に基づく改善タスクと将来機能を、優先度順に整理したものです。

参照ログ: `logs/20250829_173010_825.log`, `logs/20250829_183927_171.log`, `logs/20250830_024543_667.log`, `logs/20250830_035010_363.log`

## P0（必須・最優先）


### 01. シーン単位ベース合成（背景＋静止オブジェクト）を事前生成

- タイトル: シーン内の繰り返し合成を1回に集約してCPUフィルタ負荷を削減
- 詳細: 背景、固定の挿入画像、静止立ち絵など「行ごとに変わらない静的レイヤ」をシーン開始時に一度だけ合成したベース映像を生成・キャッシュ（ephemeral でも可）。各発話行ではこのベース映像に字幕と音声（＋必要なら短尺の挿入動画音声）だけを重ねる。これにより overlay/scale の繰り返しと I/O を大幅に削減。
- 背景: `logs/20250829_183927_171.log` で VideoPhase が 143.48s（全体の大半）。各行ごとに PNG字幕/立ち絵/挿入を毎回合成しているため CPU フィルタがボトルネック。
- ゴール: シーンあたりの合成回数を減らし、VideoPhase の p50/p95 を 30–50% 以上短縮。
- 実装イメージ: `VideoPhase.run` 冒頭でシーン構成を解析 → 変化しないレイヤを `video_renderer.render_scene_base(...)` で一回だけ合成 → 各行では `render_clip_from_base(base_path, subtitle, audio, insert_video?)` を実行。キャッシュキーは scene_hash + 静的レイヤ構成 + video/audio params。

補足（今回ログ）:
- すべてのシーンで「generated base with 0 static overlay(s)」と記録（`logs/20250830_024543_667.log`）。実際には立ち絵（例: `zundamon/default.png`）の座標/スケールが行間で不変なケースが多く、静的レイヤとして事前合成できるはず。静的判定の条件（ファイルパス・位置・スケール・不透明度・ブレンド）が全行で一致するかをシーン前処理で判定し、静的に寄せる。

### 03. 背景・挿入メディアの事前正規化・再利用（シーン単位）

- タイトル: 行ごと正規化の重複を排除し、I/O とエンコードを削減
- 詳細: シーン内で繰り返し使う背景動画・挿入動画を、シーン開始時に一括で `normalize_media`→長さ調整（ループ/トリム）して使い回す。`CacheManager.get_or_create_normalized_video` を明示的に利用し、`insert` もシーンスコープで解決。
- 背景: ログに `Cache disabled` 下でも正規化実行が複数回発生。1本あたり 7s 程度（NVENC）かかっており、積み上がると重い。
- ゴール: 同一ファイルの正規化を1度に集約し、シーン当たり数秒〜十数秒の短縮。
- 実装イメージ: `VideoPhase.run` 内で scene-level の「素材テーブル」を構築し、行処理から参照。キャッシュキーは元パス＋ターゲット仕様＋長さ指定。

補足（今回ログ）:
- `assets/bg/countdown.mp4` の正規化が失敗後に同一ラン内で再実行されており、同一ターゲットへの「正規化済み一時ファイル再利用」が効いていない（02:50:12→02:50:28 台）。失敗時にもプロセス内メモ（dict）で「対象→一時正規化パス」を保持し、再試行では再正規化せずに既存の出力を参照する。

### 24. 字幕PNG生成のレイテンシばらつき解消（フォント初期化とレイアウトのキャッシュ）

- タイトル: 字幕PNG生成で稀に数秒スパイクが発生する問題の解消
- 詳細:
    - 通常は 20–40ms 程度で生成されるが、最新ログでは 5.9s 近い生成時間が一度観測された（フォントロード/レイアウト計算のキャッシュ不在が疑い）。
    - Pillow の `ImageFont.truetype`、文字幅計算、折返し計算をプロセス内でプリロード/キャッシュ（LRU）し、同一フォント/サイズ/ストロークの組合せのレイアウト結果を再利用。
    - 生成は既にオンデマンドだが、VideoPhase 前に全台詞を先読み生成（ワーカー=CPUコア/2）するオプションも提供。
- 背景: `logs/20250830_035010_363.log` の 03:53:10→03:53:16 で PNG 1枚の生成に ~5.96s。
- ゴール: 字幕PNG生成の p95 を <100ms に安定化。
- 実装イメージ: `components/subtitle_png.py` でフォントロードのシングルトン化、文字列→レイアウトの LRU、`--precache-subtitles` フラグの追加。

### 25. `--no-cache` 時でも同一ラン内重複計算を抑止（インメモリ重複排除）

- タイトル: キャッシュ無効オプション使用時でも、同一入力に対する正規化/字幕PNG/音声合成の重複を抑止
- 詳細:
    - 最新ログでは「Cache disabled」下で同一字幕PNG・正規化映像の再生成が散見。`--no-cache` はディスクキャッシュを無効化するが、プロセス内メモリの重複排除は有効化すべき。
    - ハッシュキー（入力パス＋変換パラメータ＋長さ）→一時出力パスを dict で保持し、同一ラン内の再試行/リトライ時は既存の一時結果を参照。
- 背景: `logs/20250830_035010_363.log` で FFmpeg エラー後に同一字幕PNGの再生成が連続。
- ゴール: 失敗時のリトライでも計算重複をゼロに近づけ、秒〜十数秒単位の無駄を削減。
- 実装イメージ: `cache.py` に `EphemeralRunCache`（プロセス内辞書）を追加し、`video.py`/`subtitle_png.py`/`ffmpeg_utils.py` が参照。

### 04. RAMディスク利用と同時実行数の適応制御

- タイトル: I/O 待ちを最小化しつつ GPU/CPU の飽和を回避
- 詳細: 一時出力先として `/dev/shm`（空き容量チェック付き）を優先。`clip_workers` を HW 検出と実測に基づき自動調整（NVENC=1〜2、CPUのみ=CPU/2 など）。`-filter_threads`/`-threads:v` をワーカー数に応じて設定。
- 背景: VideoPhase が支配的。I/O と CPU フィルタの両輪で時間を消費している可能性が高い。GPU が1基の場合は並列し過ぎるとスループットが低下。
- ゴール: システム構成に応じた安定したスループットを確保。ワークロード変動時でも p95 を悪化させない。
- 実装イメージ: `temp_dir` 初期化時に RAMディスク候補を選択。`_determine_clip_workers` を HW/Encoder 種別と `nvidia-smi`/実測に基づき調整。FFmpeg に `-filter_threads N` を付与。

補足（今回ログ）:
- ログでは `clip_workers=6`、`-filter_threads 12` が観測され、GPU フィルタ失敗の温床に。NVENC+GPUフィルタ時は `clip_workers=1〜2`、`-filter_threads=1` を上限とする保守的既定を推奨。

### 05. 正規化済み一時ファイルの再正規化抑止（ディレクトリ非依存のメタ検証）

- タイトル: 正規化済みMP4を再度 `normalize_media` に通してしまう重複処理の排除
- 詳細: `logs/20250829_183927_171.log` にて `assets/bg/sample_video.mp4 -> temp_normalized_x.mp4` の直後に、再び `temp_normalized_x.mp4 -> temp_normalized_y.mp4` と正規化が走っている。`CacheManager.get_or_create_normalized_video` の「自己再正規化回避」判定が `parent == cache_dir` に依存しているため、temp_dir 配下の正規化物を入力にすると回避できない。入出力メタ（`.meta.json`）の一致で回避するように条件を拡張。
- 背景: VideoPhase の時間を押し上げる隠れた重複処理で、NVENC でも1本 ~7s 程度かかる。
- ゴール: 正規化の二重実行をゼロにし、同一ターゲット仕様の連続正規化を回避。
- 実装イメージ: 入力が `temp_normalized_*.mp4` かどうかに依らず、隣接の `.meta.json` を探し `target_spec` 一致を確認→一致なら即 return。`cache_dir` 固有パスへの依存を除去。

### 06. 動画結合（-f concat -c copy）の速度検証と入出力最適化

- 背景: 正規化完了（17:33:29）から結合完了（17:34:08）まで ~39s。入力本数が多い場合の I/O が支配的な可能性。
- 対応: 一時リストファイルの配置を `temp_dir` に変更、ストレージI/Oを計測。必要に応じてクリップ数をシーン内で先に `concat` でまとめるなどの段階的結合を導入。
- 検証: 同条件で結合所要が短縮されること（p95 を記録）。

### 07. ログ整形の乱れ修正（観測容易性）

- 背景: `17:30:24,44` のような桁欠落や `[...] omitted` の混入があり、時系列追跡が阻害。
- 対応: tqdm と logger の干渉回避（tqdm.write / logging の混用規約化、QueueHandler化）。ログフォーマッタのミリ秒桁固定。
- 検証: 次回ログで欠落・混入が解消されていること。

## P1（重要・中期）

### 07. `--no-cache` 時の挙動とログ文言の明確化

- 背景: `cache/` に一時ファイルが生成されるため混乱。
- 対応: 一時出力は `temp_dir` に統一し、ログに `Persistent=OFF / Ephemeral=...` を明示。

### 08. 同一素材の重複プローブ抑止（短期メモ化）

- 背景: 同一パス＋同一規格要求への連続 `ffprobe`/比較が発生。
- 対応: プロセス内メモ化（LRU/短期dict）で N 回以内はヒットさせる。

### 09. 字幕クリップ生成のスループット改善

- 背景: PNG生成と合成の並列度が律速になりがち。
- 対応: `clip_workers` の自動最適化、`-filter_threads`/`-filter_complex_threads` の見直し、PNG生成を ProcessPool へ。

### 10. VOICEVOX 音声合成の並列化

- 背景: AudioPhase 27.42s。セリフ数増で直列だと増大。
- 対応: スピーカーID単位での並列化上限を設定し `asyncio.gather` で束ねる。レート制限配慮。

### 11. Insert メディア正規化経路の統一（`normalize_media` へ）

- 背景: Insert だけ旧API経路が混在。
- 対応: すべて `normalize_media` に統一し、HW検出/オプション/フォールバックの一貫性を確保。

### 12. FinalizePhase の `--final-copy-only` をCLIに配線

- 目的: 再エンコードへのフォールバックを抑止した厳格運用を可能に。

### 13. 字幕フォントのフェイルセーフ

- 背景: 指定フォント不在時の失敗回避。
- 対応: 系統フォントへのフォールバックと警告ログ。

## P2（改善・将来・機能追加）

### 14. 口パク（リップシンク）対応（静止立ち絵の口形アニメ）

- 機能: 音声から音素/ビセームを推定し、`characters/*` の口形差分PNGを時間同期で切替。
- 実装案: 軽量な音素推定（pyopenjtalk/phoneme forced alignment 等）→ タイムラインへ mouth=OPEN/CLOSE を注入 → `render_clip` で overlay 切替。
- 代替: 音量包絡で簡易口パク（閾値2段階）。

### 15. フィルター/エフェクトのプリセット

- 機能: ぼかし/ビネット/色調（LUT）/色温度/ズームパン（Ken Burns）などを行/シーン単位で適用。
- 実装案: `line_config.effects[]` を追加し、`filter_complex` を合成。RGBA無しなら CUDA フィルタ採用。

### 16. トランジション拡充とテンプレ（xfade 以外）

- 機能: スライド/ワイプ/グリッチ/ズーム等の遷移。テンプレ名指定で適用。
- 実装案: `apply_transition` の種類を追加し、パラメータ化。

### 17. カラオケ風字幕（逐次ハイライト/グラデ/縁取り強化）

- 機能: 読上げ進行に応じて文字色を流す。影/縁取り/アウトライン色の詳細設定。
- 実装案: 固定PNGではなく分割PNG or drawboxレイヤ併用、または WebVTT → ffmpeg `subtitles` フィルタ採用の選択肢も検討。

### 17. ピクチャー・イン・ピクチャー（PIP）とフェイスカム枠

- 機能: 任意の動画/画像を右下などにPIP表示。枠・角丸・影のオプション。

### 18. BGM ビート検出と自動カット合わせ

- 機能: BGM の拍に台詞/カットを寄せるオプション。
- 実装案: 簡易オンセット検出 → タイムラインの開始時刻を微調整。

### 19. SRT/WebVTT の入出力

- 機能: 外部字幕との互換（インポート/エクスポート）。

### 20. プレビュー高速レンダリングモード

- 機能: 低解像度+低ビットレートでのクイックプレビュー（最終出力前の確認用）。
- 実装案: `--preview` で `VideoParams` を縮小し、字幕PNGキャッシュを使い回し。

### 21. 背景除去/クロマキー（簡易）

- 機能: 立ち絵/挿入動画の背景透過やクロマキー除去。

### 22. キーフレーム的パラメトリックアニメ

- 機能: 位置/スケール/不透明度を時間指定で変化（ズーム/パン/フェード）。

### 23. プロジェクトテンプレ/テーマ

- 機能: 共通の構成/スタイルをテンプレとして使い回し。

## 補足（今回ログでの主な観測ポイント）

- `AudioPhase` は 27.42s（問題小）。
- `VideoPhase` は 205.31s と支配的。17:32:37 台で `scene_bg_intro.mp4` について `[Cache] Normalized miss` が多数発生（重複正規化の疑い）。
- `assets/bg/countdown.mp4` の正規化は NVENC で 9s 程度（正常）。
- シーン結合（-c copy）は成功しているが ~39s 要しており、I/O 最適化余地あり。
