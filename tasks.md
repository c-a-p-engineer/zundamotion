# 📋 Zundamotion タスクリスト（優先度順・再整理）

本ファイルは、最新ログを踏まえた改善タスクのみを掲載します（完了済みは削除）。

参照ログ: `logs/20250908_081408_745.log`, `logs/20250908_074624_481.log`, `logs/20250908_073444_688.log`

最新観測サマリ（2025-09-08 実行・直近）:
- 総所要: 151.92s。内訳: AudioPhase ~14.0s / VideoPhase 117.10s / BGMPhase 2.51s / FinalizePhase 19.45s。
- GPUエンコードはNVENCを利用。HWフィルタはCPU固定ヒント→CPU経路（`GPU overlay backend=none (scale_only=True)` だがCPUモードのため未使用）。
- 起動直後から `clip_workers=2`（CPUモード初期抑制が有効）、AutoTune後は `filter_threads` が 4→2 に調整。
- Top5重いクリップが 9.36/7.55/6.91/5.40s まで短縮（ベース生成/正規化の効果）。
- 一方で全体 VideoPhase は ~117s レベルで頭打ち（CPU overlay 支配）。


## P1（品質向上・高速化）

### 01. GPUスケール専用スモークとCPUモード時の限定解禁（高速化・大）
- 背景: `scale_cuda|scale_npp` が使える環境でも、CPUモードに固定されるとハイブリッド（GPUスケールのみ）が無効のまま。過去に218で失敗したため保守的に抑止中。
- 目的: 実行スモーク（hwupload_cuda→scale_*→hwdownload）に通った環境では、CPUモードでも安全に「GPUスケールのみ」を許可。
- 方針: `smoke_test_cuda_scale_only()` を追加し、成功時のみ `video.gpu_scale_with_cpu_overlay` を有効化。失敗時は自動でCPU固定を継続。
- 成果確認: `Filter path usage` の `gpu_scale_only` が増加し、VideoPhase が有意に短縮。

### 02. AutoTuneヒントの無効化条件と再評価（品質・中）
- 背景: `autotune_hint.json` によりCPU固定が持ち越され、GPU環境に切替後もCPU継続のリスク。
- 目的: 環境変化（GPU有無/ffmpegビルド/ドライバ）を検知してヒントを無効化し再評価。
- 方針: ヒントに `cuda_smoke_ok`/GPU枚数/ドライバ版のハッシュを保持。乖離時はヒントを無視してGPU経路を再スモーク。
- 成果確認: GPU利用可能時に自動で `HW_FILTER_MODE=auto` 相当の再評価が働く。

### 03. CPUフィルタ時の既定スレッドCAP最適化（高速化・小）
- 背景: CPUモード初期は `filter_threads` CAP=4→AutoTuneで2へ。初期から2にすると安定（本ログでもAutoTune適用後は2）。
- 目的: 先頭クリップの過負荷回避と安定化を強める。
- 方針: `get_hw_filter_mode()='cpu'` かつ `clip_workers<=2` のとき、既定CAPを2に設定（環境変数未指定時）。
- 成果確認: 先頭クリップの所要とCPU使用率がさらに安定。


## P2（改善・将来・機能追加）

### 01. VOICEVOX 音声合成の並列化（スピーカー単位の上限）
- 背景: 今回ログではAudioPhaseは8%と支配的ではないが、行数が多い脚本で効く改善。
- 目的: スループット向上と安定性（レート制限回避）。
- 方針: `asyncio.Semaphore` による全体/話者別上限、タイムアウト/リトライ調整、並列度統計のログ化。
- 成果確認: 大規模台本での短縮とエラー無増加。

### 01. 口パク（音素/ビセーム）最小実装
- 機能: 音素/ビセーム推定に基づき口形 PNG を時間同期で切替。
- 背景: 現状は最小版（音量しきい値）を実装済。精度向上の余地あり。
- ゴール: 音素ベースで自然な口形遷移。
- 実装案: pyopenjtalk 等で音素列→ビセーム時系列→`face_anim` 注入。
- 確認方法: デバッグ可視化用に mouth state をログ/タイムライン出力。

### 02. フィルター/エフェクトのプリセット
- 機能: ぼかし/ビネット/色調/LUT/ズームパン等を行/シーン単位で適用。
- 背景: 表現力の拡充要望。
- ゴール: 既存スキーマ最小拡張で汎用エフェクト適用。
- 実装案: `line_config.effects[]` を追加し filter_complex に合成。RGBA 無しなら GPU backend を優先。
- 確認方法: 比較用ゴールデン映像と目視/ヒストグラム比較。

### 03. トランジション拡充（テンプレ化）
- 機能: スライド/ワイプ/グリッチ等のテンプレ追加。
- 背景: xfade 以外の需要。
- ゴール: 種類/パラメータ化を `apply_transition` に統合。
- 実装案: 種別ごとに filter_complex を実装、CLI/スキーマから選択。
- 確認方法: サンプル台本で連結動作と境界の音切れ無しを確認。

### 04. カラオケ風字幕
- 機能: 読み上げ進行に合わせてテキストをハイライト。
- 背景: 表現の拡張。
- ゴール: 視認性と同期精度の確保。
- 実装案: 分割 PNG/マスクレイヤ or `subtitles` フィルタ併用。
- 確認方法: 音声とハイライトの誤差 < 100ms。

### 05. ピクチャー・イン・ピクチャー（PIP）
- 機能: 任意の動画/画像を枠付きで重畳表示。
- 背景: 解説/ゲーム実況等の需要。
- ゴール: 角丸/影/枠のオプション提供。
- 実装案: 追加 overlay チェーンと簡易 UI スキーマ。
- 確認方法: 位置/サイズ/枠のオプションが効くこと。

### 06. BGM ビート検出と自動カット合わせ
- 機能: BGM の拍に台詞/カットを寄せる。
- 背景: テンポ感の向上。
- ゴール: 過剰な調整を避けつつ自然な合わせ。
- 実装案: オンセット検出→開始時刻微調整。
- 確認方法: クリック音デバッグとタイムライン比較。

### 07. SRT/WebVTT の入出力
- 機能: 外部字幕のインポート/エクスポート。
- 背景: 互換性確保。
- ゴール: 双方向変換を提供。
- 実装案: `Timeline` 拡張、parser/writer 追加。
- 確認方法: 既存ツールとの相互運用テスト。

### 08. プレビュー高速レンダリングモード
- 機能: 低解像度/低ビットレートでのクイックプレビュー。
- 背景: 繰り返し調整の高速化。
- ゴール: 本番設定に影響を与えずプレビューのみ高速化。
- 実装案: `--preview` で `VideoParams` を縮小、字幕PNGは共通キャッシュ。
- 確認方法: プレビュー所要が大幅短縮されること。

### 09. 背景除去/クロマキー（簡易）
- 機能: 立ち絵/動画の背景透過/色キー除去。
- 背景: グリーンバック素材の活用。
- ゴール: 破綻の少ない単純除去。
- 実装案: `colorkey`/`chromakey`/差分合成の適用。
- 確認方法: 境界ノイズ/色抜けの目視確認。

### 10. キーフレーム的パラメトリックアニメ
- 機能: 位置/スケール/不透明度の時間変化。
- 背景: 表現力向上。
- ゴール: シンプルな指定で自然な動き。
- 実装案: 簡易キーフレーム→補間→ filter_complex 反映。
- 確認方法: モーション軌跡のログ/動画で検証。

### 11. プロジェクトテンプレ/テーマ
- 機能: 構成/スタイルのテンプレ化。
- 背景: セットアップ時間短縮。
- ゴール: 再利用性向上。
- 実装案: `templates/` 整備と CLI スキャフォールド。
- 確認方法: ひな形からの生成が成功すること。

### 12. 吹き出し/ネームプレート（話者UI）
- 機能: キャラ名入りの吹き出し/プレート表示。
- 背景: 話者識別の明確化。
- ゴール: 視認性と読みやすさ向上。
- 実装案: 吹き出しPNGテンプレ＋テキスト合成 or 字幕拡張。
- 確認方法: レイアウト崩れや被りがないこと。

### 13. YAMLスキーマ拡張（assets辞書・字幕スタイルテンプレ）
- 機能: パス直書きを避け、テンプレ/辞書参照を可能に。
- 背景: 冗長性/編集コストの削減。
- ゴール: スキーマの簡素化と可読性向上。
- 実装案: `script_loader` でテンプレ展開・検証を追加。
- 確認方法: 既存・新形式の双方で正しく解決されること。

### 14. 自動ポーズ/句読点ルール
- 機能: 句読点等で自動ポーズを挿入。
- 背景: 自然な発話テンポ。
- ゴール: 過剰/不足のないポーズ。
- 実装案: テキスト整形→無音区間挿入。
- 確認方法: タイムライン/耳での確認。

### 15. サムネ/チャプター自動生成
- 機能: キーシーンの静止画・YouTube チャプターTXT出力。
- 背景: 投稿準備の効率化。
- ゴール: 最小操作で公開可。
- 実装案: `Timeline` から境界抽出→ ffmpeg でサムネ生成。
- 確認方法: 生成物の内容/時刻が妥当であること。
