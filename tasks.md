# 📋 Zundamotion タスクリスト（優先度順）

本ファイルは、現状コード・ログの観察結果に基づく改善タスクと将来機能を、優先度順に整理したものです。

## P0（必須・最優先）

### 01. time_logデコレータの非同期対応（誤った0.00秒計測の是正）

- 背景: `@time_log` が `async def` を同期関数として包んでおり、即座にコルーチンを返すため開始/終了ログが実処理前後に対応せず、`Duration: 0.00 seconds` となる。
- 影響: `GenerationPipeline.run`、`AudioPhase.run`、`VideoPhase.run`、`BGMPhase.run`、`FinalizePhase.run` の時間計測とログの整合性が崩れる。
- 対応: デコレータでコルーチン関数を検出し、`async def wrapper` にして `await func(*)` を実行。計測に `time.monotonic()` を使用。
- 確認: `logs/20250829_112339_645.log:4-9, 41-45` のような 0.00 秒表記が実時間（例: `VideoPhase completed in 184.98 seconds.` と一致）に是正される。


### 02. 正規化キャッシュの自己再正規化防止

* 背景: 正規化済みファイルを再び “Normalized miss” として扱っている。
* ゴール: 正規化済みファイルが再度処理されない。
* 実装イメージ:
  * 入力ファイルと目標規格のハッシュキーでキャッシュ判定。
  * 正規化済みファイルにメタ情報を付与し再投入を避ける。
  * `cache/temp_normalized_*.mp4` は正規化対象から除外。
* 確認方法: 「Successfully normalized …」直後に “Normalized miss” が出ない。

### 03. フェーズ時間計測の実態反映

* 背景: `VideoPhase.run` 等が `Duration: 0.00 seconds` と出るケースがある。
* ゴール: 各フェーズの実行時間が正しくログ出力される。
* 実装イメージ:
  * `time.monotonic()` で測定、平均/最大/p95 を集計し最終サマリで出力。
* 確認方法: `VideoPhase` のログが実時間（例: ~173秒）を反映。

### 04. NVENCスモークテストの冗長実行抑制

* 背景: `h264_nvenc` スモークテストが複数回走るケースがある。
* ゴール: プロセス内で1回だけテストし、結果をキャッシュ利用。
* 実装イメージ: モジュールスコープキャッシュ（既に `_nvenc_availability_cache` あり）を徹底活用、重複起動箇所がないか確認。
* 確認方法: ログでスモークテストが最初の1回のみ表示。

### 05. 正規化でのNVENC失敗時フォールバック（libx264再試行）

- 背景: 正規化処理で `h264_nvenc` を選択し失敗（exit code 234）しているが、自動フォールバックがなく ERROR で途切れる箇所がある。
- 兆候: `logs/20250829_112339_645.log:66-68` にて `assets/bg/countdown.mp4` 正規化時に `-c:v h264_nvenc` で失敗。
- 対応: `CacheManager.get_or_create_normalized_video` 実行中に FFmpeg 失敗を捕捉し、`h264_nvenc` → `libx264` へ自動置換したコマンドで1回だけ再試行。警告ログも付与。
- 代替/将来: 旧経路（`build_normalize_cmd_async`）を撤廃し、`normalize_media`（HW検出とオプション統一済み）へ移行。
- 確認: 同一素材でエラーが出ず、正規化完了ログが出る。

## P1（重要・中期）

### 05. `--no-cache` 時の挙動とログ文言の明確化

* 背景: `--no-cache` 時でも `cache/` 配下に一時ファイルが置かれ混乱。
* ゴール: 永続キャッシュOFFと一時ファイル（エフェメラル）の区別を明示。
* 実装イメージ: ログに `Persistent=OFF / Ephemeral=/tmp/...` を表示。パスも明確化。

### 06. 同一素材の重複プローブ抑止

* 背景: 同一素材のプローブや正規化判定が複数回発生。
* ゴール: 同一パス＋同一規格要求の再プローブを避ける。
* 実装イメージ: `CacheManager` にプローブ結果の短期メモ化dictを導入。

### 07. 字幕クリップ生成のスループット改善

* 背景: 字幕PNG→動画焼き込みが直列で重い。
* ゴール: クリップ生成時間を約50%短縮。
* 実装イメージ: `-filter_threads` の最適化、前処理の正規化段階集約、並列化（ProcessPoolExecutor）。

### 08. VOICEVOX音声合成の並列化

* 背景: セリフの合成が直列実行される場合がある。
* ゴール: 適切な並列化で待ち時間を短縮。
* 実装イメージ: `asyncio.gather` 等でのバッチ化（負荷/レート制限に配慮）。

### 09. FFmpeg並列最適化とGPU活用の強化

* 背景: RGBAオーバーレイでCPUフィルタにフォールバック。
* ゴール: 可能なケースでGPUフィルタ（overlay_cuda等）を活用。
* 実装イメージ: フィルタ組み合わせの最適化、`-preset`/`-tune` 調整、`-c copy` 適用範囲拡大。

### 10. ドキュメント/依存の同期（人/AI向け）

* 背景: ルートに `requirements.txt` がなく、AI_READMEの構造表記にも差分があった。
* ゴール: ルート `requirements.txt` の整備、AI_README/READMEの内容を最新コードに同期（実装済み）。

### 11. FinalizePhaseの`final_copy_only`をCLIに配線

* 背景: 再エンコードにフォールバックさせたくない運用要件がある。
* ゴール: `--final-copy-only`（仮）で `-c copy` 失敗時は即エラー終了。

### 12. 字幕フォントのフェイルセーフ

### 13. Insertメディア正規化経路の統一（重複ロジック解消）

- 背景: Insertメディアの正規化で `CacheManager.get_or_create_normalized_video`（旧実装）を使用、他方で背景等は `normalize_media` を使用しており二重実装になっている。
- 影響: エンコーダ選択/プリセット/音声オプションの不一致やNVENC失敗時の挙動差。
- 対応: `components/video.py` 内の insert 正規化呼び出しを `normalize_media` に置き換え、HW検出とエンコード方針を統一。
- 確認: 正規化コマンドの一貫性（ログ）と失敗時のフォールバック挙動が統一される。

### 14. VideoPhaseの並列度制御と実測短縮

- 背景: `VideoPhase` 全体で約 185 秒を要している（`logs/...:84`）。クリップ生成が直列に近く、I/OとCPUの待ちが目立つ可能性。
- 対応: 字幕PNG生成とFFmpegクリップ合成の並列実行を上限付きで導入（例: `asyncio.Semaphore` で同時N本まで）。メトリクスを取り、p95短縮を確認。
- 確認: クリップあたり平均時間・p95が改善し、全体時間が短縮。

### 15. `--no-cache` 時の一時出力先を `temp_dir` へ集約

- 背景: `Cache disabled. Generating temporary file: temp_...` が `cache/` 配下に出力され混乱を招く。
- 対応: `no_cache=True` の場合は一時ファイルを `temp_dir`（パイプラインのワーキング一時ディレクトリ）配下に生成。ログにも出力先の種別を明示。
- 確認: キャッシュと一時のディレクトリ/ログ表現が明確に分かれる。

* 背景: 指定フォントが存在しない環境で失敗する可能性。
* ゴール: `SubtitlePNGRenderer` でフォントパスが無効な場合のフォールバック（システム標準）を追加。

## P2（改善・将来）

### 13. 音声エンコーダの自動フォールバック

* 背景: `libmp3lame` がない環境でPCMに落ちる。
* ゴール: `libmp3lame`/`aac` を自動切り替え。

### 14. キャッシュ機構の拡張（フィルタグラフ中間結果）

* 背景: 中間結果の再利用で更なる時短余地。
* ゴール: 主要ステップの中間結果キャッシュを検討（費用対効果評価込み）。

### 15. FFmpegの継続的アップデート検証

* 背景: 最新機能や最適化を取り込む余地。
* ゴール: 定期的な検証で性能/安定性の向上。

### 16. 非同期処理の徹底とI/O待ち最適化

* 背景: I/Oバウンド箇所のブロック回避が更に可能。
* ゴール: `asyncio` 化の徹底、`create_subprocess_exec` の活用最適化。

### 17. プレフライト診断コマンド

* 背景: 初回起動時のトラブルシュート容易化。
* ゴール: `ffmpeg`/`ffprobe`/GPU/VOICEVOX 接続確認の一括診断を追加。

### 18. 最小ユニットテストの追加

* 背景: 回帰防止・信頼性向上。
* ゴール: `CacheManager` と `ffmpeg_utils` の要点（ハッシュ、正規化判定、NVENC検出）に対する軽量テストを整備。
