# 📋 Zundamotion タスクリスト（優先度順・再整理）

本ファイルは、最新ログを踏まえた改善タスクのみを掲載します（完了済みは削除）。

参照ログ: `logs/20250902_022808_840.log`, `logs/20250902_023125_440.log`, `logs/20250831_172922_025.log`

最新観測サマリ（2025-09-02 実行）:
- エンコードは NVENC 利用。字幕PNGや立ち絵で RGBA 合成が発生し CPU overlay 経路が優勢。
- シーン結合は `-f concat -c copy` で成功。I/O スループットは ~80MB/s 程度（ログ追加済み）。
- 主なボトルネックは VideoPhase（CPU overlay）。

## P0（必須・最優先）

### 01. CUDA 非対応時の GPU overlay 代替
- 概要: CUDA フィルタ不可（exit 218 等）の環境で、OpenCL/Vulkan/QSV overlay 等に自動切替。
- 対応: `ffmpeg_utils.has_*_filters()` と軽量スモークテストを追加し、`VideoRenderer` の経路選択に反映。
- 目的: CPU overlay 依存からの脱却による VideoPhase 時間の大幅短縮。

### 02. キャラ画像の事前スケール/キャッシュ（overlay 負荷の削減）
- 概要: 立ち絵 PNG のスケールを Pillow で事前適用し、一時/永続キャッシュ。ffmpeg 側の scale 負荷を削減。
- 対応: `FaceOverlayCache` 相当のキャラ版キャッシュを追加（scale×path キー）。`render_clip` で pre-scaled を優先。
- 目的: CPU overlay の filter_complex を軽量化（合成のみ）。

### 03. AutoTune の永続化と早期バックオフ
- 概要: 初期クリップの計測結果（CPU overlay 優勢）をプロセス間で共有し、次回以降は早期に `HW_FILTER_MODE=cpu` とスレッド上限/並列数を抑制。
- 対応: temp/persistent にヒントファイルを書き出し、`VideoPhase.create` で読み取り。ログ整備。
- 目的: ランごとの最初の数クリップでの手探り時間を削減。

## P1（重要・中期）

### 01. VOICEVOX 音声合成の並列化（スピーカー単位の上限）
- 概要: スピーカーIDごとの並列上限を設けつつ `asyncio.gather` で束ね、レート制限に配慮。
- 目的: セリフ数が多い台本で AudioPhase のスループットを向上。

### 02. FinalizePhase の `--final-copy-only` CLI 配線
- 概要: `-c copy` 失敗時の再エンコードを禁止する運用オプションを公開。
- 目的: 品質/速度ポリシーに応じた厳格運用を可能に。

### 03. 字幕フォントのフェイルセーフ
- 概要: 指定フォント不在時、系統フォントへ自動フォールバック＋警告ログ。

### 04. 字幕クリップ生成のスループット改善
- 概要: PNG生成の ProcessPool 化、`clip_workers`/`-filter_threads` の見直しで全体レイテンシを均質化。

## P2（改善・将来・機能追加）

### 01. 口パク（音素/ビセーム）最小実装
### 02. フィルター/エフェクトのプリセット
### 03. トランジション拡充（テンプレ化）
### 04. カラオケ風字幕
### 05. ピクチャー・イン・ピクチャー（PIP）
### 06. BGM ビート検出と自動カット合わせ
### 07. SRT/WebVTT の入出力
### 08. プレビュー高速レンダリングモード
### 09. 背景除去/クロマキー（簡易）
### 10. キーフレーム的パラメトリックアニメ
### 11. プロジェクトテンプレ/テーマ
### 12. 吹き出し/ネームプレート（話者UI）
### 13. YAMLスキーマ拡張（assets辞書・字幕スタイルテンプレ）
### 14. 自動ポーズ/句読点ルール
### 15. サムネ/チャプター自動生成

