# 📋 Zundamotion タスクリスト（優先度順）

本ファイルは、現状コード・ログの観察結果に基づく改善タスクと将来機能を、優先度順に整理したものです。

参照ログ: `logs/20250831_004024_506.log`, `logs/20250830_155656_544.log`

### 最新ログサマリ（2025-08-31 実行）

- AudioPhase: 15.09s（問題小）
- VideoPhase: 91.55s（支配的）
- BGMPhase: 2.68s / Finalize: 0.82s
- 開始直後に CUDA フィルタのスモークテストが exit 218 で失敗し、CPU フィルタへフォールバック（`clip_workers=6`）。
- シーンベース映像は「generated base with 0 static overlay(s)」が観測され、固定コストが発生。
- クリップ本数は合計 23 本（subtitle/voice/intro/topic/outro）。

## P0（必須・最優先）


### 02. 静的オーバーレイ無しのシーンでベース映像生成をスキップ＋二重スケール回避

- タイトル: `static_overlays=0` のシーンはベース映像（背景のみのループ書き出し）を省略し、行単位処理へ直行
- 詳細:
    - 現状は静的オーバーレイが無くても毎シーンでベース映像（`render_scene_base`→`render_looped_background_video`）を書き出しており、1シーンあたり ~10–15s 程度の固定コストが発生している。
    - 代替として、背景が正規化済み（`normalize_media` 経由）なら `pre_scaled=True` を `background_config` に付与し、行側の `filter_complex` から `scale=` を外して二重スケールを避ける。
    - 行数が多い場合のブレークイーブンは設定で調整（しきい値 N 行以上でのみベース生成）。初期値は N=6 など。
- 背景（今回ログ）: 各シーンで「generated base with 0 static overlay(s)」が出力されており、恩恵が薄いケースで固定コストが発生。
- ゴール: ベース生成の不要コスト削減と行側の二重スケール抑止。
- 実装イメージ: `video_phase.py` で `static_overlays` が空のときはベース生成をスキップ。`video.py/render_clip` 内で正規化済み入力に `pre_scaled` を伝播。


### 03. 背景・挿入メディアの事前正規化・再利用（シーン単位）

- タイトル: 行ごと正規化の重複を排除し、I/O とエンコードを削減
- 詳細: シーン内で繰り返し使う背景動画・挿入動画を、シーン開始時に一括で `normalize_media`→長さ調整（ループ/トリム）して使い回す。`CacheManager.get_or_create_normalized_video` を明示的に利用し、`insert` もシーンスコープで解決。
- 背景: ログに `Cache disabled` 下でも正規化実行が複数回発生。1本あたり 7s 程度（NVENC）かかっており、積み上がると重い。
- ゴール: 同一ファイルの正規化を1度に集約し、シーン当たり数秒〜十数秒の短縮。
- 実装イメージ: `VideoPhase.run` 内で scene-level の「素材テーブル」を構築し、行処理から参照。キャッシュキーは元パス＋ターゲット仕様＋長さ指定。

補足（今回ログ）:
- `assets/bg/countdown.mp4` の正規化が失敗後に同一ラン内で再実行されており、同一ターゲットへの「正規化済み一時ファイル再利用」が効いていない（02:50:12→02:50:28 台）。失敗時にもプロセス内メモ（dict）で「対象→一時正規化パス」を保持し、再試行では再正規化せずに既存の出力を参照する。


### 04. シーン間トランジション適用（YAML→Finalize 配線）

- タイトル: `scene.transition` の検証済み設定を最終結合に反映（映像xfade＋音声acrossfade）
- 詳細:
    - 既に `script_loader` で `transition` を検証、`ffmpeg_utils.apply_transition()` も実装済だが、最終結合に未配線。
    - `FinalizePhase.run` で隣接シーンを順に処理し、先行シーンの `transition` を適用して一時ファイルを生成→新しい配列へ格納。
    - 生成済みのトランジション付きクリップ群に対して `-c copy` 連結を試行し、失敗時のみ再エンコードへフォールバック。
- ゴール: YAMLのトランジション定義が映像・音声に反映され、カットが滑らかになる。
- 実装イメージ: `components/pipeline_phases/finalize_phase.py` に適用ループを追加。`apply_transition()` に `VideoParams/AudioParams` を渡す。


### 05. 口パク/目パチ（最小版・音量しきい値）

- タイトル: ゆっくり的な口パク・まばたきの簡易実装（差分PNG切替）
- 詳細:
    - 音声WAVを一定FPSでRMSサンプリングし、二段閾値で mouth={close,half,open} を時系列化。
    - 目パチは 2–5 秒ランダムで ON/OFF（複数フレーム）をスケジュール。
    - アセット規約: `assets/characters/<name>/mouth/{close,half,open}.png`, `eyes/{open,close}.png`（存在しない場合は自動無効化）。
    - `render_clip` の `filter_complex` に `enable='between(t,...)'` 付き overlay を追加して差分を重ねる。
- ゴール: TTSが無くても“ゆっくりらしさ”が出る最低限のアニメーション。
- 実装イメージ: `AudioPhase` でRMSタイムラインを生成→`line_data_map` へ注入→`VideoRenderer.render_clip` で overlay 差し替え。

### 26. リトライ時の字幕PNG再利用（I/O最小化）

- タイトル: CUDA→CPU フォールバック時の PNG 再生成を抑止
- 詳細: 最新ログでは CUDA 失敗のたびに字幕PNGが毎回再生成されている（例: 04:27:52, 04:27:56 付近）。フォールバック再実行では同一 PNG パスを再利用し、再レイアウト/再書込を避ける。
- ゴール: クリップ失敗時のフォールバック処理で 50–150ms/回 程度を削減。
- 実装イメージ: `render_clip` 内で生成した字幕PNGパスを保持し、リトライ呼び出しに引き継ぎ（引数 or 一時メモ）。

### 24. 字幕PNG生成のレイテンシばらつき解消（フォント初期化とレイアウトのキャッシュ）

- タイトル: 字幕PNG生成で稀に数秒スパイクが発生する問題の解消
- 詳細:
    - 通常は 20–40ms 程度で生成されるが、最新ログでは 5.9s 近い生成時間が一度観測された（フォントロード/レイアウト計算のキャッシュ不在が疑い）。
    - Pillow の `ImageFont.truetype`、文字幅計算、折返し計算をプロセス内でプリロード/キャッシュ（LRU）し、同一フォント/サイズ/ストロークの組合せのレイアウト結果を再利用。
    - 生成は既にオンデマンドだが、VideoPhase 前に全台詞を先読み生成（ワーカー=CPUコア/2）するオプションも提供。
- 背景: `logs/20250830_035010_363.log` の 03:53:10→03:53:16 で PNG 1枚の生成に ~5.96s。
- ゴール: 字幕PNG生成の p95 を <100ms に安定化。
- 実装イメージ: `components/subtitle_png.py` でフォントロードのシングルトン化、文字列→レイアウトの LRU、`--precache-subtitles` フラグの追加。

### 25. `--no-cache` 時でも同一ラン内重複計算を抑止（インメモリ重複排除）

- タイトル: キャッシュ無効オプション使用時でも、同一入力に対する正規化/字幕PNG/音声合成の重複を抑止
- 詳細:
    - 最新ログでは「Cache disabled」下で同一字幕PNG・正規化映像の再生成が散見。`--no-cache` はディスクキャッシュを無効化するが、プロセス内メモリの重複排除は有効化すべき。
    - ハッシュキー（入力パス＋変換パラメータ＋長さ）→一時出力パスを dict で保持し、同一ラン内の再試行/リトライ時は既存の一時結果を参照。
- 背景: `logs/20250830_035010_363.log` で FFmpeg エラー後に同一字幕PNGの再生成が連続。
- ゴール: 失敗時のリトライでも計算重複をゼロに近づけ、秒〜十数秒単位の無駄を削減。
- 実装イメージ: `cache.py` に `EphemeralRunCache`（プロセス内辞書）を追加し、`video.py`/`subtitle_png.py`/`ffmpeg_utils.py` が参照。

### 04. RAMディスク利用と同時実行数の適応制御

- タイトル: I/O 待ちを最小化しつつ GPU/CPU の飽和を回避
- 詳細: 一時出力先として `/dev/shm`（空き容量チェック付き）を優先。`clip_workers` を HW 検出と実測に基づき自動調整（NVENC=1〜2、CPUのみ=CPU/2 など）。`-filter_threads`/`-threads:v` をワーカー数に応じて設定。
- 背景: VideoPhase が支配的。I/O と CPU フィルタの両輪で時間を消費している可能性が高い。GPU が1基の場合は並列し過ぎるとスループットが低下。
- ゴール: システム構成に応じた安定したスループットを確保。ワークロード変動時でも p95 を悪化させない。
- 実装イメージ: `temp_dir` 初期化時に RAMディスク候補を選択。`_determine_clip_workers` を HW/Encoder 種別と `nvidia-smi`/実測に基づき調整。FFmpeg に `-filter_threads N` を付与。

補足（今回ログ）:
- ログでは `clip_workers=6`、`-filter_threads 12` が観測され、GPU フィルタ失敗の温床に。NVENC+GPUフィルタ時は `clip_workers=1〜2`、`-filter_threads=1` を上限とする保守的既定を推奨。

### 05. 正規化済み一時ファイルの再正規化抑止（ディレクトリ非依存のメタ検証）

- タイトル: 正規化済みMP4を再度 `normalize_media` に通してしまう重複処理の排除
- 詳細: `logs/20250829_183927_171.log` にて `assets/bg/sample_video.mp4 -> temp_normalized_x.mp4` の直後に、再び `temp_normalized_x.mp4 -> temp_normalized_y.mp4` と正規化が走っている。`CacheManager.get_or_create_normalized_video` の「自己再正規化回避」判定が `parent == cache_dir` に依存しているため、temp_dir 配下の正規化物を入力にすると回避できない。入出力メタ（`.meta.json`）の一致で回避するように条件を拡張。
- 背景: VideoPhase の時間を押し上げる隠れた重複処理で、NVENC でも1本 ~7s 程度かかる。
- ゴール: 正規化の二重実行をゼロにし、同一ターゲット仕様の連続正規化を回避。
- 実装イメージ: 入力が `temp_normalized_*.mp4` かどうかに依らず、隣接の `.meta.json` を探し `target_spec` 一致を確認→一致なら即 return。`cache_dir` 固有パスへの依存を除去。

### 06. 動画結合（-f concat -c copy）の速度検証と入出力最適化

- 背景: 正規化完了（17:33:29）から結合完了（17:34:08）まで ~39s。入力本数が多い場合の I/O が支配的な可能性。
- 対応: 一時リストファイルの配置を `temp_dir` に変更、ストレージI/Oを計測。必要に応じてクリップ数をシーン内で先に `concat` でまとめるなどの段階的結合を導入。
- 検証: 同条件で結合所要が短縮されること（p95 を記録）。

### 07. ログ整形の乱れ修正（観測容易性）

- 背景: `17:30:24,44` のような桁欠落や `[...] omitted` の混入があり、時系列追跡が阻害。
- 対応: tqdm と logger の干渉回避（tqdm.write / logging の混用規約化、QueueHandler化）。ログフォーマッタのミリ秒桁固定。
- 検証: 次回ログで欠落・混入が解消されていること。

## P1（重要・中期）

### 27. CUDA不可時のGPUフィルタ代替（OpenCL/Vulkan/QSV overlay の検討）

- タイトル: CUDAフィルタ未対応/失敗環境でのGPU合成代替パスを用意
- 詳細:
    - `overlay_cuda/scale_cuda` が使えない環境向けに、`overlay_opencl` や `overlay_vulkan`（ビルド有効時）、`overlay_qsv` の存在確認とスモークテストを追加。成功時はCPUフィルタではなく当該GPUフィルタを採用。
    - 字幕や立ち絵のアルファ合成要件に応じ、各フィルタのサポート状況を調査し、可能な範囲で適用（不可なら自動でCPU）。
- 背景: `logs/20250830_155656_544.log` で CUDA フィルタのスモークテストが exit 218 で失敗、以降CPU合成となり VideoPhase が支配的に。
- ゴール: CUDA非対応環境でもGPU合成経路を確保し、CPU負荷を軽減。
- 実装イメージ: `ffmpeg_utils.has_*_filters()` を追加し、`VideoRenderer` のフィルタ選択に反映。軽量スモークテストとプロセス内キャッシュはCUDAと同様に実装。

### 07. `--no-cache` 時の挙動とログ文言の明確化

- 背景: `cache/` に一時ファイルが生成されるため混乱。
- 対応: 一時出力は `temp_dir` に統一し、ログに `Persistent=OFF / Ephemeral=...` を明示。

### 08. 同一素材の重複プローブ抑止（短期メモ化）

- 背景: 同一パス＋同一規格要求への連続 `ffprobe`/比較が発生。
- 対応: プロセス内メモ化（LRU/短期dict）で N 回以内はヒットさせる。

### 09. 字幕クリップ生成のスループット改善

- 背景: PNG生成と合成の並列度が律速になりがち。
- 対応: `clip_workers` の自動最適化、`-filter_threads`/`-filter_complex_threads` の見直し、PNG生成を ProcessPool へ。

### 10. VOICEVOX 音声合成の並列化

- 背景: AudioPhase 27.42s。セリフ数増で直列だと増大。
- 対応: スピーカーID単位での並列化上限を設定し `asyncio.gather` で束ねる。レート制限配慮。

### 11. Insert メディア正規化経路の統一（`normalize_media` へ）

- 背景: Insert だけ旧API経路が混在。
- 対応: すべて `normalize_media` に統一し、HW検出/オプション/フォールバックの一貫性を確保。

### 12. FinalizePhase の `--final-copy-only` をCLIに配線

- 目的: 再エンコードへのフォールバックを抑止した厳格運用を可能に。

### 13. 字幕フォントのフェイルセーフ

- 背景: 指定フォント不在時の失敗回避。
- 対応: 系統フォントへのフォールバックと警告ログ。

## P2（改善・将来・機能追加）

### 14. 口パク（リップシンク）対応（静止立ち絵の口形アニメ）

- 機能: 音声から音素/ビセームを推定し、`characters/*` の口形差分PNGを時間同期で切替。
- 実装案: 軽量な音素推定（pyopenjtalk/phoneme forced alignment 等）→ タイムラインへ mouth=OPEN/CLOSE を注入 → `render_clip` で overlay 切替。
- 代替: 音量包絡で簡易口パク（閾値2段階）。

### 15. フィルター/エフェクトのプリセット

- 機能: ぼかし/ビネット/色調（LUT）/色温度/ズームパン（Ken Burns）などを行/シーン単位で適用。
- 実装案: `line_config.effects[]` を追加し、`filter_complex` を合成。RGBA無しなら CUDA フィルタ採用。

### 16. トランジション拡充とテンプレ（xfade 以外）

- 機能: スライド/ワイプ/グリッチ/ズーム等の遷移。テンプレ名指定で適用。
- 実装案: `apply_transition` の種類を追加し、パラメータ化。

### 17. カラオケ風字幕（逐次ハイライト/グラデ/縁取り強化）

- 機能: 読上げ進行に応じて文字色を流す。影/縁取り/アウトライン色の詳細設定。
- 実装案: 固定PNGではなく分割PNG or drawboxレイヤ併用、または WebVTT → ffmpeg `subtitles` フィルタ採用の選択肢も検討。

### 17. ピクチャー・イン・ピクチャー（PIP）とフェイスカム枠

- 機能: 任意の動画/画像を右下などにPIP表示。枠・角丸・影のオプション。

### 18. BGM ビート検出と自動カット合わせ

- 機能: BGM の拍に台詞/カットを寄せるオプション。
- 実装案: 簡易オンセット検出 → タイムラインの開始時刻を微調整。

### 19. SRT/WebVTT の入出力

- 機能: 外部字幕との互換（インポート/エクスポート）。

### 20. プレビュー高速レンダリングモード

- 機能: 低解像度+低ビットレートでのクイックプレビュー（最終出力前の確認用）。
- 実装案: `--preview` で `VideoParams` を縮小し、字幕PNGキャッシュを使い回し。

### 21. 背景除去/クロマキー（簡易）

- 機能: 立ち絵/挿入動画の背景透過やクロマキー除去。

### 22. キーフレーム的パラメトリックアニメ

- 機能: 位置/スケール/不透明度を時間指定で変化（ズーム/パン/フェード）。

### 23. プロジェクトテンプレ/テーマ

- 機能: 共通の構成/スタイルをテンプレとして使い回し。


### 24. 吹き出し/ネームプレート（話者UI）

- 機能: キャラ名付きの吹き出し/プレートを表示。左右配置に応じ自動位置。
- 実装案: 吹き出しPNGテンプレ＋テキスト合成、もしくは字幕PNGの別スタイル枠で重畳。

### 25. YAMLスキーマ拡張（assets辞書・字幕スタイルテンプレ）

- 機能: パス直書きを減らし、`assets.*` キー参照で再利用。字幕スタイルのテンプレ名参照。
- 実装案: `script_loader.merge_configs` でテンプレ展開、検証の強化と README 追記。

### 26. 自動ポーズ/句読点ルール

- 機能: 句読点・三点リーダ等で短ポーズを自動挿入。長音/中点列の伸ばし。
- 実装案: 合成前のテキスト整形（オプション）と `AudioPhase` の無音挿入。

### 27. サムネ/チャプター自動生成

- 機能: キーシーンから静止画サムネ／YouTubeチャプター用TXTを自動出力。
- 実装案: `Timeline` のイベントからシーン境界を抽出し、`output.mp4` からフレーム書き出し。

## 補足（今回ログでの主な観測ポイント）

- `AudioPhase` は 27.42s（問題小）。
- `VideoPhase` は 205.31s と支配的。17:32:37 台で `scene_bg_intro.mp4` について `[Cache] Normalized miss` が多数発生（重複正規化の疑い）。
- `assets/bg/countdown.mp4` の正規化は NVENC で 9s 程度（正常）。
- シーン結合（-c copy）は成功しているが ~39s 要しており、I/O 最適化余地あり。

- 直近ログ: `logs/20250830_155656_544.log`
  - `AudioPhase` は 15.17s（問題小）。
  - `VideoPhase` は 111.72s と支配的。開始直後に CUDA フィルタのスモークテストが失敗→CPUフィルタへフォールバック。`clip_workers=2` でCPUフィルタが飽和し切れていない可能性。
  - シーンベース映像は「0 static overlay(s)」のまま生成され、固定コストが発生。`pre_scaled` 伝播による二重スケール回避で置換可能。
  - 背景正規化は NVENC で短時間に完了（例: `sample_video.mp4` ~1.26s、`countdown.mp4` ~5.05s）。
  - BGMPhase 3.40s、FinalizePhase 0.78s と軽微。最終結合は `-c copy` 成功。
