# 📋 Zundamotion タスクリスト（優先度順）

本ファイルは、現状コード・ログの観察結果に基づく改善タスクと将来機能を、優先度順に整理したものです。

## P0（必須・最優先）

### 01. VideoRendererの非同期バグ修正（has_audio_streamのawait漏れ）

* 背景: `zundamotion/components/video.py` の `render_clip` 内で `has_audio_stream()`（async）がawaitされておらず、常に真として扱われる可能性がある。
* ゴール: `await has_audio_stream(...)` として正しく判定し、無音生成/ミックス分岐を正しく行う。
* 確認方法: 挿入動画のみ・音声なしのケースで無音生成への分岐が正しく働く（実装済み）。

### 02. 正規化キャッシュの自己再正規化防止

* 背景: 正規化済みファイルを再び “Normalized miss” として扱っている。
* ゴール: 正規化済みファイルが再度処理されない。
* 実装イメージ:
  * 入力ファイルと目標規格のハッシュキーでキャッシュ判定。
  * 正規化済みファイルにメタ情報を付与し再投入を避ける。
  * `cache/temp_normalized_*.mp4` は正規化対象から除外。
* 確認方法: 「Successfully normalized …」直後に “Normalized miss” が出ない。

### 03. フェーズ時間計測の実態反映

* 背景: `VideoPhase.run` 等が `Duration: 0.00 seconds` と出るケースがある。
* ゴール: 各フェーズの実行時間が正しくログ出力される。
* 実装イメージ:
  * `time.monotonic()` で測定、平均/最大/p95 を集計し最終サマリで出力。
* 確認方法: `VideoPhase` のログが実時間（例: ~173秒）を反映。

### 04. NVENCスモークテストの冗長実行抑制

* 背景: `h264_nvenc` スモークテストが複数回走るケースがある。
* ゴール: プロセス内で1回だけテストし、結果をキャッシュ利用。
* 実装イメージ: モジュールスコープキャッシュ（既に `_nvenc_availability_cache` あり）を徹底活用、重複起動箇所がないか確認。
* 確認方法: ログでスモークテストが最初の1回のみ表示。

## P1（重要・中期）

### 05. `--no-cache` 時の挙動とログ文言の明確化

* 背景: `--no-cache` 時でも `cache/` 配下に一時ファイルが置かれ混乱。
* ゴール: 永続キャッシュOFFと一時ファイル（エフェメラル）の区別を明示。
* 実装イメージ: ログに `Persistent=OFF / Ephemeral=/tmp/...` を表示。パスも明確化。

### 06. 同一素材の重複プローブ抑止

* 背景: 同一素材のプローブや正規化判定が複数回発生。
* ゴール: 同一パス＋同一規格要求の再プローブを避ける。
* 実装イメージ: `CacheManager` にプローブ結果の短期メモ化dictを導入。

### 07. 字幕クリップ生成のスループット改善

* 背景: 字幕PNG→動画焼き込みが直列で重い。
* ゴール: クリップ生成時間を約50%短縮。
* 実装イメージ: `-filter_threads` の最適化、前処理の正規化段階集約、並列化（ProcessPoolExecutor）。

### 08. VOICEVOX音声合成の並列化

* 背景: セリフの合成が直列実行される場合がある。
* ゴール: 適切な並列化で待ち時間を短縮。
* 実装イメージ: `asyncio.gather` 等でのバッチ化（負荷/レート制限に配慮）。

### 09. FFmpeg並列最適化とGPU活用の強化

* 背景: RGBAオーバーレイでCPUフィルタにフォールバック。
* ゴール: 可能なケースでGPUフィルタ（overlay_cuda等）を活用。
* 実装イメージ: フィルタ組み合わせの最適化、`-preset`/`-tune` 調整、`-c copy` 適用範囲拡大。

### 10. ドキュメント/依存の同期（人/AI向け）

* 背景: ルートに `requirements.txt` がなく、AI_READMEの構造表記にも差分があった。
* ゴール: ルート `requirements.txt` の整備、AI_README/READMEの内容を最新コードに同期（実装済み）。

### 11. FinalizePhaseの`final_copy_only`をCLIに配線

* 背景: 再エンコードにフォールバックさせたくない運用要件がある。
* ゴール: `--final-copy-only`（仮）で `-c copy` 失敗時は即エラー終了。

### 12. 字幕フォントのフェイルセーフ

* 背景: 指定フォントが存在しない環境で失敗する可能性。
* ゴール: `SubtitlePNGRenderer` でフォントパスが無効な場合のフォールバック（システム標準）を追加。

## P2（改善・将来）

### 13. 音声エンコーダの自動フォールバック

* 背景: `libmp3lame` がない環境でPCMに落ちる。
* ゴール: `libmp3lame`/`aac` を自動切り替え。

### 14. キャッシュ機構の拡張（フィルタグラフ中間結果）

* 背景: 中間結果の再利用で更なる時短余地。
* ゴール: 主要ステップの中間結果キャッシュを検討（費用対効果評価込み）。

### 15. FFmpegの継続的アップデート検証

* 背景: 最新機能や最適化を取り込む余地。
* ゴール: 定期的な検証で性能/安定性の向上。

### 16. 非同期処理の徹底とI/O待ち最適化

* 背景: I/Oバウンド箇所のブロック回避が更に可能。
* ゴール: `asyncio` 化の徹底、`create_subprocess_exec` の活用最適化。

### 17. プレフライト診断コマンド

* 背景: 初回起動時のトラブルシュート容易化。
* ゴール: `ffmpeg`/`ffprobe`/GPU/VOICEVOX 接続確認の一括診断を追加。

### 18. 最小ユニットテストの追加

* 背景: 回帰防止・信頼性向上。
* ゴール: `CacheManager` と `ffmpeg_utils` の要点（ハッシュ、正規化判定、NVENC検出）に対する軽量テストを整備。
