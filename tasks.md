# 📋 Zundamotion タスクリスト（優先度順）

本ファイルは、現状コード・ログの観察結果に基づく改善タスクと将来機能を、優先度順に整理したものです。

参照ログ: `logs/20250831_172922_025.log`, `logs/20250831_004024_506.log`, `logs/20250830_155656_544.log`

### 最新ログサマリ（2025-08-31 17:29 実行）

- AudioPhase: ≈14.1s（概算、問題小）
- VideoPhase: 136.09s（支配的）
- BGMPhase: 2.59s / Finalize: 34.27s
- NVENCのスモークテストは成功→エンコードはNVENC使用。
- CUDAフィルタのスモークテストが exit 218 で失敗し、以降CPUフィルタへフォールバック。
- スレッド: `clip_workers=2`, `filter_threads=6`, `filter_complex_threads=6`（CPU経路の既定ヒューリスティクス通り）。

## P0（必須・最優先）


### 01. CUDAフィルタ smoke test (exit 218) の根因究明と対策

- タイトル: CUDA フィルタ（overlay_cuda/scale_cuda）スモーク失敗の恒常化を解消
- 詳細:
    - 本日のログでも `overlay_cuda` を用いたスモークが exit 218 で失敗。NVENC は利用可能だが、合成が CPU 経路になり VideoPhase が支配的に。
    - 調査観点: FFmpeg のビルド構成（`--enable-cuda-nvcc`/`--enable-libnpp` 有無）、ドライバ/ランタイム互換、色空間/ピクセルフォーマット（RGBA→NV12）変換、フィルタ依存関係。
    - 観測性強化: スモーク失敗時に `ffmpeg -hide_banner -buildconf`, `ffmpeg -filters`, `nvidia-smi -L`, `nvcc --version`（存在すれば）をINFOで一括出力（1回/プロセス）。
    - ワークアラウンド: `scale_cuda`→`scale_npp` の切替可否、`format=rgba|nv12` の明示、`hwupload_cuda` の挿入位置見直し（ベンチ付き）。
- ゴール: CUDAフィルタ経路が正常化するか、少なくとも失敗理由がログに明確化され、恒常的にCPU経路へ落ちない。
- 実装イメージ: `ffmpeg_utils.py` のスモークテスト強化と失敗時ダンプ、フィルタグラフの前処理（`format/hwupload`）見直しフラグの追加。

### 02. CPUフィルタ経路の最適化（filter_threads/complex_threads の上限とプロファイル）

- タイトル: CPU 合成時のスレッド設定とプロファイリング強化で VideoPhase を短縮
- 詳細:
    - 現状ヒューリスティクス（nproc=12, clip_workers=2 → filter_threads=6）は妥当だが、filter_complex_threads の効果は限定的なケースが多い。
    - `-filter_threads` と `-filter_complex_threads` の上限を小さめにキャップ（例: 1〜4）し、`-benchmark -stats` を一時付与してFFmpegの実測をログ採取→最適域を探索。
- ゴール: CPU経路でも過剰スレッドによるオーバーヘッドを抑え、VideoPhaseの p50/p95 を有意に短縮。
- 実装イメージ: `ffmpeg_utils.py` にプロファイルモードを追加し、実測に基づく保守的既定値へ調整。


### 24. 字幕PNG生成のレイテンシばらつき解消（フォント初期化とレイアウトのキャッシュ）

- タイトル: 字幕PNG生成で稀に数秒スパイクが発生する問題の解消
- 詳細:
    - 通常は 20–40ms 程度で生成されるが、最新ログでは 5.9s 近い生成時間が一度観測された（フォントロード/レイアウト計算のキャッシュ不在が疑い）。
    - Pillow の `ImageFont.truetype`、文字幅計算、折返し計算をプロセス内でプリロード/キャッシュ（LRU）し、同一フォント/サイズ/ストロークの組合せのレイアウト結果を再利用。
    - 生成は既にオンデマンドだが、VideoPhase 前に全台詞を先読み生成（ワーカー=CPUコア/2）するオプションも提供。
- 背景: `logs/20250830_035010_363.log` の 03:53:10→03:53:16 で PNG 1枚の生成に ~5.96s。
- ゴール: 字幕PNG生成の p95 を <100ms に安定化。
- 実装イメージ: `components/subtitle_png.py` でフォントロードのシングルトン化、文字列→レイアウトの LRU、`--precache-subtitles` フラグの追加。

### 25. `--no-cache` 時でも同一ラン内重複計算を抑止（インメモリ重複排除）

- タイトル: キャッシュ無効オプション使用時でも、同一入力に対する正規化/字幕PNG/音声合成の重複を抑止
- 詳細:
    - 最新ログでは「Cache disabled」下で同一字幕PNG・正規化映像の再生成が散見。`--no-cache` はディスクキャッシュを無効化するが、プロセス内メモリの重複排除は有効化すべき。
    - ハッシュキー（入力パス＋変換パラメータ＋長さ）→一時出力パスを dict で保持し、同一ラン内の再試行/リトライ時は既存の一時結果を参照。
- 背景: `logs/20250830_035010_363.log` で FFmpeg エラー後に同一字幕PNGの再生成が連続。
- ゴール: 失敗時のリトライでも計算重複をゼロに近づけ、秒〜十数秒単位の無駄を削減。
- 実装イメージ: `cache.py` に `EphemeralRunCache`（プロセス内辞書）を追加し、`video.py`/`subtitle_png.py`/`ffmpeg_utils.py` が参照。

### 04. RAMディスク利用と同時実行数の適応制御

- タイトル: I/O 待ちを最小化しつつ GPU/CPU の飽和を回避
- 詳細: 一時出力先として `/dev/shm`（空き容量チェック付き）を優先。`clip_workers` を HW 検出と実測に基づき自動調整（NVENC=1〜2、CPUのみ=CPU/2 など）。`-filter_threads`/`-threads:v` をワーカー数に応じて設定。
- 背景: VideoPhase が支配的。I/O と CPU フィルタの両輪で時間を消費している可能性が高い。GPU が1基の場合は並列し過ぎるとスループットが低下。
- ゴール: システム構成に応じた安定したスループットを確保。ワークロード変動時でも p95 を悪化させない。
- 実装イメージ: `temp_dir` 初期化時に RAMディスク候補を選択。`_determine_clip_workers` を HW/Encoder 種別と `nvidia-smi`/実測に基づき調整。FFmpeg に `-filter_threads N` を付与。

補足（今回ログ 20250831_172922_025）:
- 本件ログでは `clip_workers=2`, `filter_threads=6` と保守的な設定で稼働。CUDAフィルタ失敗が主因でCPU合成となり、VideoPhaseが支配。
- CUDA経路が復旧すれば、ここは `clip_workers=1〜2`, `-filter_threads=1` 上限でも十分スループットが改善見込み。

### 05. 正規化済み一時ファイルの再正規化抑止（ディレクトリ非依存のメタ検証）

- タイトル: 正規化済みMP4を再度 `normalize_media` に通してしまう重複処理の排除
- 詳細: `logs/20250829_183927_171.log` にて `assets/bg/sample_video.mp4 -> temp_normalized_x.mp4` の直後に、再び `temp_normalized_x.mp4 -> temp_normalized_y.mp4` と正規化が走っている。`CacheManager.get_or_create_normalized_video` の「自己再正規化回避」判定が `parent == cache_dir` に依存しているため、temp_dir 配下の正規化物を入力にすると回避できない。入出力メタ（`.meta.json`）の一致で回避するように条件を拡張。
- 背景: VideoPhase の時間を押し上げる隠れた重複処理で、NVENC でも1本 ~7s 程度かかる。
- ゴール: 正規化の二重実行をゼロにし、同一ターゲット仕様の連続正規化を回避。
- 実装イメージ: 入力が `temp_normalized_*.mp4` かどうかに依らず、隣接の `.meta.json` を探し `target_spec` 一致を確認→一致なら即 return。`cache_dir` 固有パスへの依存を除去。

### 06. 動画結合（-f concat -c copy）の速度検証と入出力最適化

- 背景: 正規化完了（17:33:29）から結合完了（17:34:08）まで ~39s。入力本数が多い場合の I/O が支配的な可能性。
- 対応: 一時リストファイルの配置を `temp_dir` に変更、ストレージI/Oを計測。必要に応じてクリップ数をシーン内で先に `concat` でまとめるなどの段階的結合を導入。
- 検証: 同条件で結合所要が短縮されること（p95 を記録）。

### 07. ログ整形の乱れ修正（観測容易性）

- 背景: `17:30:24,44` のような桁欠落や `[...] omitted` の混入があり、時系列追跡が阻害。
- 対応: tqdm と logger の干渉回避（tqdm.write / logging の混用規約化、QueueHandler化）。ログフォーマッタのミリ秒桁固定。
- 検証: 次回ログで欠落・混入が解消されていること。

## P1（重要・中期）

### 27. CUDA不可時のGPUフィルタ代替（OpenCL/Vulkan/QSV overlay の検討）

- タイトル: CUDAフィルタ未対応/失敗環境でのGPU合成代替パスを用意
- 詳細:
    - `overlay_cuda/scale_cuda` が使えない環境向けに、`overlay_opencl` や `overlay_vulkan`（ビルド有効時）、`overlay_qsv` の存在確認とスモークテストを追加。成功時はCPUフィルタではなく当該GPUフィルタを採用。
    - 字幕や立ち絵のアルファ合成要件に応じ、各フィルタのサポート状況を調査し、可能な範囲で適用（不可なら自動でCPU）。
- 背景: `logs/20250830_155656_544.log` で CUDA フィルタのスモークテストが exit 218 で失敗、以降CPU合成となり VideoPhase が支配的に。
- ゴール: CUDA非対応環境でもGPU合成経路を確保し、CPU負荷を軽減。
- 実装イメージ: `ffmpeg_utils.has_*_filters()` を追加し、`VideoRenderer` のフィルタ選択に反映。軽量スモークテストとプロセス内キャッシュはCUDAと同様に実装。

### 07. `--no-cache` 時の挙動とログ文言の明確化

- 背景: `cache/` に一時ファイルが生成されるため混乱。
- 対応: 一時出力は `temp_dir` に統一し、ログに `Persistent=OFF / Ephemeral=...` を明示。

### 08. 同一素材の重複プローブ抑止（短期メモ化）

- 背景: 同一パス＋同一規格要求への連続 `ffprobe`/比較が発生。
- 対応: プロセス内メモ化（LRU/短期dict）で N 回以内はヒットさせる。

### 09. 字幕クリップ生成のスループット改善

- 背景: PNG生成と合成の並列度が律速になりがち。
- 対応: `clip_workers` の自動最適化、`-filter_threads`/`-filter_complex_threads` の見直し、PNG生成を ProcessPool へ。

### 10. VOICEVOX 音声合成の並列化

- 背景: AudioPhase 27.42s。セリフ数増で直列だと増大。
- 対応: スピーカーID単位での並列化上限を設定し `asyncio.gather` で束ねる。レート制限配慮。

### 11. Insert メディア正規化経路の統一（`normalize_media` へ）

- 背景: Insert だけ旧API経路が混在。
- 対応: すべて `normalize_media` に統一し、HW検出/オプション/フォールバックの一貫性を確保。

### 12. FinalizePhase の `--final-copy-only` をCLIに配線

- 目的: 再エンコードへのフォールバックを抑止した厳格運用を可能に。

### 13. 字幕フォントのフェイルセーフ

- 背景: 指定フォント不在時の失敗回避。
- 対応: 系統フォントへのフォールバックと警告ログ。

## P2（改善・将来・機能追加）

### 14. 口パク（リップシンク）対応（静止立ち絵の口形アニメ）

- 機能: 音声から音素/ビセームを推定し、`characters/*` の口形差分PNGを時間同期で切替。
- 実装案: 軽量な音素推定（pyopenjtalk/phoneme forced alignment 等）→ タイムラインへ mouth=OPEN/CLOSE を注入 → `render_clip` で overlay 切替。
- 代替: 音量包絡で簡易口パク（閾値2段階）。

### 15. フィルター/エフェクトのプリセット

- 機能: ぼかし/ビネット/色調（LUT）/色温度/ズームパン（Ken Burns）などを行/シーン単位で適用。
- 実装案: `line_config.effects[]` を追加し、`filter_complex` を合成。RGBA無しなら CUDA フィルタ採用。

### 16. トランジション拡充とテンプレ（xfade 以外）

- 機能: スライド/ワイプ/グリッチ/ズーム等の遷移。テンプレ名指定で適用。
- 実装案: `apply_transition` の種類を追加し、パラメータ化。

### 17. カラオケ風字幕（逐次ハイライト/グラデ/縁取り強化）

- 機能: 読上げ進行に応じて文字色を流す。影/縁取り/アウトライン色の詳細設定。
- 実装案: 固定PNGではなく分割PNG or drawboxレイヤ併用、または WebVTT → ffmpeg `subtitles` フィルタ採用の選択肢も検討。

### 17. ピクチャー・イン・ピクチャー（PIP）とフェイスカム枠

- 機能: 任意の動画/画像を右下などにPIP表示。枠・角丸・影のオプション。

### 18. BGM ビート検出と自動カット合わせ

- 機能: BGM の拍に台詞/カットを寄せるオプション。
- 実装案: 簡易オンセット検出 → タイムラインの開始時刻を微調整。

### 19. SRT/WebVTT の入出力

- 機能: 外部字幕との互換（インポート/エクスポート）。

### 20. プレビュー高速レンダリングモード

- 機能: 低解像度+低ビットレートでのクイックプレビュー（最終出力前の確認用）。
- 実装案: `--preview` で `VideoParams` を縮小し、字幕PNGキャッシュを使い回し。

### 21. 背景除去/クロマキー（簡易）

- 機能: 立ち絵/挿入動画の背景透過やクロマキー除去。

### 22. キーフレーム的パラメトリックアニメ

- 機能: 位置/スケール/不透明度を時間指定で変化（ズーム/パン/フェード）。

### 23. プロジェクトテンプレ/テーマ

- 機能: 共通の構成/スタイルをテンプレとして使い回し。


### 24. 吹き出し/ネームプレート（話者UI）

- 機能: キャラ名付きの吹き出し/プレートを表示。左右配置に応じ自動位置。
- 実装案: 吹き出しPNGテンプレ＋テキスト合成、もしくは字幕PNGの別スタイル枠で重畳。

### 25. YAMLスキーマ拡張（assets辞書・字幕スタイルテンプレ）

- 機能: パス直書きを減らし、`assets.*` キー参照で再利用。字幕スタイルのテンプレ名参照。
- 実装案: `script_loader.merge_configs` でテンプレ展開、検証の強化と README 追記。

### 26. 自動ポーズ/句読点ルール

- 機能: 句読点・三点リーダ等で短ポーズを自動挿入。長音/中点列の伸ばし。
- 実装案: 合成前のテキスト整形（オプション）と `AudioPhase` の無音挿入。

### 27. サムネ/チャプター自動生成

- 機能: キーシーンから静止画サムネ／YouTubeチャプター用TXTを自動出力。
- 実装案: `Timeline` のイベントからシーン境界を抽出し、`output.mp4` からフレーム書き出し。

## 補足（今回ログでの主な観測ポイント）

- `AudioPhase` は 27.42s（問題小）。
- `VideoPhase` は 205.31s と支配的。17:32:37 台で `scene_bg_intro.mp4` について `[Cache] Normalized miss` が多数発生（重複正規化の疑い）。
- `assets/bg/countdown.mp4` の正規化は NVENC で 9s 程度（正常）。
- シーン結合（-c copy）は成功しているが ~39s 要しており、I/O 最適化余地あり。

- 直近ログ: `logs/20250830_155656_544.log`
  - `AudioPhase` は 15.17s（問題小）。
  - `VideoPhase` は 111.72s と支配的。開始直後に CUDA フィルタのスモークテストが失敗→CPUフィルタへフォールバック。`clip_workers=2` でCPUフィルタが飽和し切れていない可能性。
  - シーンベース映像は「0 static overlay(s)」のまま生成され、固定コストが発生。`pre_scaled` 伝播による二重スケール回避で置換可能。
  - 背景正規化は NVENC で短時間に完了（例: `sample_video.mp4` ~1.26s、`countdown.mp4` ~5.05s）。
  - BGMPhase 3.40s、FinalizePhase 0.78s と軽微。最終結合は `-c copy` 成功。
