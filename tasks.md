# 📋 Zundamotion タスクリスト（優先度順・再整理）

本ファイルは、最新ログを踏まえた改善タスクを優先度順に記載します（完了済みは削除）。
各タスクは「背景 / 目的 / 方針 / 実装イメージ / 成果確認」の形式で詳細化します。

参照ログ（最新→古い順）: `logs/20250923_182534_403.log`, `logs/20250911_062724_974.log`, `logs/20250910_045352_758.log`, `logs/20250910_041524_580.log`

最新観測サマリ（2025-09-23 実行）:
- 総所要: 287.61s。内訳: AudioPhase 10.94s / VideoPhase 252.60s / BGMPhase 4.66s / FinalizePhase 16.70s。
- ボトルネック: VideoPhase（約88%）。`Filter path usage: cuda_overlay=0, opencl_overlay=0, gpu_scale_only=21, cpu=0`。
  - CUDA/OpenCL フィルタは存在するがスモーク未合格→GPU overlay 無効、GPUスケールのみ有効。
  - ログに「Hybrid path: GPU scale + CPU overlay (background only) [cpu-mode-override]」。ハイブリッド経路に固定。
  - Slowest line clips（例）: 9.58s / 8.45s / 4.89s / 2.86s（字幕＋立ち絵、挿入メディア無し）。
- FFmpegスレッド自動調整: nproc=12 → `clip_workers=3`, `threads=4`, `filter_threads=2`。
- ConcatCopyは高速（~160MB/s）。

## P1（品質・高速化の優先タスク）

### 01. GPUオーバーレイ（OpenCL/CUDA）の実運用化とフォールバック最適化
- 背景: CUDA/OpenCLは検出されるがスモーク未合格でGPU overlayが無効化され、VideoPhaseがCPU overlay支配に。
- 目的: 安定性を保ちつつGPU overlayを実運用化。失敗時はクリップ単位でCPUへ安全フォールバック。
- 方針:
  - `video.allow_opencl_overlay_in_cpu_mode` を有効化可能にし（既定は無効）、スモーク合格時は CPU モードでも `overlay_opencl` を許可。
  - クリップ単位のフォールバックに変更（現状のプロセス全体`cpu-mode-override`を緩和）。N連続成功でハードウェア経路を自動再有効化。
  - CUDA経路は `gpu_overlay_experimental` をON時のみRGBA対応を試験（前処理でpremultiplied alphaを徹底）。
- 実装イメージ: rendererでの `get_hw_filter_mode()` バックオフをクリップ局所状態に分離、OpenCLは `allow_opencl_overlay_in_cpu_mode` ガードで許可。失敗は例外トラップ→同クリップをCPUでリトライ。
- 成果確認: 同一入力でGPU overlay有効時に VideoPhase時間が>30%短縮、色/アルファの破綻無し。失敗時も自動でCPU再実行され完走。

### 02. シーンベース生成のスキップ条件と計測の厳密化
- 背景: 静的オーバーレイが0でもベース生成が走るケースがあり、無駄な前処理コストが発生。
- 目的: `scene_base_min_lines` しきい値と「静的オーバーレイ=0」の組み合わせで確実にベース生成をスキップ。
- 方針: ベース生成前に静的レイヤ数と行数を評価→条件未満なら背景を一度だけ正規化し各行へ伝搬（`pre_scaled=True`）。
- 実装イメージ: VideoPhaseのベース生成ブランチで条件チェックを明示、スキップ時にログを追加し効果計測。
- 成果確認: 対象シーンでベース生成の所要が0になり、行ごとの合成のみで同等品質を維持。

### 03. 立ち絵のシーン前合成（ボディ固定＋口/目だけ差し替え）
- 背景: 各行で毎回フルPNGをoverlayし直すため、行クリップの最遅が~9.6sに達する。
- 目的: 立ち絵ボディをシーン先頭でベースへ事前合成し、行ごとは口/目の差分PNGのみをoverlay。
- 方針: キャラクター配置・スケール・座標が不変な区間を検出→ボディをベース化。口/目はFaceOverlayCache済みの部分PNGのみ連結。
- 実装イメージ: YAMLの行列を走査し、キャラ属性の変化点でセグメント化→各セグメントでボディ前合成。
- 成果確認: 同シーンの行クリップ時間が平均で30〜50%短縮。画質/座標の不一致が無いこと。

### 04. ハードウェアフィルタ再有効化のヒューリスティクス
- 背景: 一度の失敗でプロセス全体がCPUモード固定になりやすい。
- 目的: 安定性を損なわずに、成功が続いたらHW経路へ自動復帰。
- 方針: 失敗→CPUリトライ成功後も、次クリップ以降に軽いスモーク（短いfiltergraph）を裏で実行し、N回成功で復帰。
- 成果確認: 不安定環境でも断続的にGPUスケール/overlayが有効化され、全体所要が改善。

### 05. ドキュメントとログの整備（既定値の整合・診断強化）
- 背景: READMEの既定値と実装が不一致（例: `allow_opencl_overlay_in_cpu_mode`）。
- 目的: 既定値の明示と診断ログの強化で、設定・環境差異による混乱を低減。
- 方針: README/AI_READMEの既定値を実装に合わせて修正、FilterDiagに「有効/不許可の理由」を文言追加。
- 成果確認: 設定だけで挙動が再現でき、問い合わせ無しで原因切り分け可能。


## P2（改善・将来・機能追加）


### 02. 複数キャラクター同時配置（レイアウト・Z順・自動配置）
- 背景: 2人/3人ショットなど同時表示ニーズ。
- 目的: `characters[]` を同時合成し、Z順・レイアウトを簡便に指定。
- 方針: `z`/`anchor`/`layout(two_shot/three_shot)`/`safe_margin` を拡張。
- 実装イメージ: テンプレレイアウト（左右/三分割）と自動スケール、重なり回避ロジックを実装。
- 成果確認: 被り・はみ出しなしで配置、Z順が意図通り。

### 03. アンカー基準点指定（キャラクター/オブジェクトの基準位置制御）
- 背景: 足元合わせや中央基準など、素材ごとに揃えたい位置が異なる。
- 目的: 各レイヤの基準点を `bottom_center` や `center` などから選択し、座標式と連動可能にする。
- 方針: YAMLスキーマに `anchor: {x: center|left|right, y: top|center|bottom}` を追加し、描画前に `offset` を計算。
- 実装イメージ: 画像メタ情報（幅/高さ）を取得→アンカーに応じたオフセット行列を生成→`overlay`/`scale` のフィルタに組み込む。
- 成果確認: 足元基準での立ち位置調整テスト、中央基準でのポップアップでブレ無し。
- 補足: 将来の3D風パララックスを見据え、アンカー情報をメタデータとして Timeline に保持。

### 04. アニメーション基盤（キーフレーム/式/補間の共通化）
- 背景: 各種揺れやズームを実装する前に、式やキーフレームを扱う共通レイヤが必要。
- 目的: `position/scale/rotate/opacity` を時間関数またはキーフレームで指定できる `anim` DSL を導入。
- 方針: `anim: {expr|keys}` を定義し、線形/イージング/サイン波のユーティリティと、共通バリデータを整備。
- 実装イメージ: FFmpeg用式テンプレ生成器を作り、`overlay`, `scale`, `rotate` フィルタへの差し込みを抽象化。式は `t` ベース、キーは補間ライブラリでサンプル化。
- 成果確認: デモシーンで x/y/scale/opacity の同時アニメが期待通り再生。CLIプレビューで再現性確保。
- 補足: 式評価失敗時にフォールバック（静止）させる安全策と、メトリクスログを追加。

### 05. 拡大縮小（Zoom in/out）時間式サポート
- 背景: 素材の寄り/引きで視線誘導したいシーンが多い。
- 目的: `scale` フィルタに時間式を設定し、滑らかなズームを可能にする。
- 方針: `anim.scale` に `expr: "lerp(1.0, 1.2, ease_in_out(t, 0, 3))"` のような式を渡せるようにし、境界処理を組み込む。
- 実装イメージ: FFmpeg `scale` の `w`/`h` パラメータへ時間依存式を埋め込み、超解像を避けるため元解像度の上限ガードを入れる。
- 成果確認: 3秒間で1.0→1.2倍のズームが破綻なく動く。上限超え時は警告ログ。
- 補足: GPU `scale_npp` 使用時も式が機能するか検証し、非対応ならCPUフォールバックを明示。

### 06. パン（左右上下移動）オーバーレイ式制御
- 背景: キャラクターやテキストを滑らかに画面内で移動させたい。
- 目的: `overlay` フィルタの `x`/`y` に時間式を設定し、直線移動やスイングを表現。
- 方針: `anim.position` で `expr` を受け取り、アンカー調整後の座標に適用。境界外にはみ出す場合は `clamp`。
- 実装イメージ: `x='lerp(start_x, end_x, ease_in_out(t,0,duration))'` のような式を生成し、`y` も同様に制御。Ken Burns の土台にする。
- 成果確認: イントロで左端→中央へ3秒移動するデモが意図通り。
- 補足: マルチレイヤ同期用に `anim.group` ID を設け、同フェーズ開始を保証。

### 07. Ken Burns（背景ズーム＋パンの複合演出）
- 背景: 静止背景でも奥行きと動きを出したい。
- 目的: 背景素材にズーム・パン・ティルトを同時適用し、イージング制御を行う。
- 方針: `background.anim` にズーム/パン式を指定し、`scale` → `crop` → `overlay` の順でフィルタチェーンを構築。
- 実装イメージ: 初期時点で余白（overscan）を確保→時間式でズーム率/パン座標を算出→`crop` で出力解像度に合わせる。Ken Burnsプリセットを複数定義。
- 成果確認: デモ背景で「静止→ゆるズーム→右上パン」が滑らかに再生。エッジ切れや黒帯が出ないこと。
- 補足: 高解像度素材を想定し、ズーム時のAliasingを防ぐため Lanczos 等のスケーラ指定をドキュメント化。

### 08. ポップイン/アウト（登場・退場スケール演出）
- 背景: キャラクターの出入りを視覚的に印象付けたい。
- 目的: 登場時に0.9→1.0倍、退場時に縮小するスケールアニメをプリセット化。
- 方針: `anim.presets.pop_in`/`pop_out` を用意し、`scale` と `opacity` の連動をサポート。
- 実装イメージ: `ease_out_back` で軽い弾みを付けたズーム式を生成し、退場時は `ease_in` で縮小→フェード。
- 成果確認: デモシーンで登場/退場が破綻なく適用。複数キャラ同時でも競合しない。
- 補足: 音声に合わせるため、タイムライン上の `cue` 連携仕様を定義。

### 09. 縦揺れ・横揺れ（wiggle）アニメーション
- 背景: 表情にニュアンスを付与したい、待機時の細かな動きを入れたい。
- 目的: サイン波＋減衰を用いた上下/左右揺れを提供。
- 方針: `anim.presets.wiggle` を定義し、`amplitude`, `frequency`, `decay` を設定可能にする。
- 実装イメージ: `y = base_y + amplitude * sin(2π * freq * t) * exp(-decay * t)` を式生成。座標系はアンカー済み基準を使用。
- 成果確認: 5秒間の待機アニメで揺れが徐々に収束。減衰0の場合はループすることを確認。
- 補足: 高周波によるモーションブラーを避けるため、最大freqを制限。

### 10. 小刻み揺れ（shake）インパクト演出
- 背景: 驚き・衝撃などの瞬間演出に小刻みな揺れを使いたい。
- 目的: 複数サイン波を合成したランダム風揺れプリセットを提供。
- 方針: `anim.presets.shake` を定義し、`x`/`y` に2〜3本のサイン波を合成。減衰とシード値で揺れの再現性を担保。
- 実装イメージ: `x = base_x + Σ amplitude_i * sin(2π * freq_i * t + phase_i)` を生成し、`freq`/`phase` を擬似乱数で決定。減衰係数で終端が静止。
- 成果確認: インパクトSEに合わせた0.5秒シェイクが意図通り。複数回呼んでも同シードなら同動作。
- 補足: 振幅が画面外に出ないようアンカー中心からの最大オフセットを制限。

### 11. 回転揺れ（rot_shake）微小回転演出
- 背景: 打撃やカメラ揺れでの角度変化が欲しい。
- 目的: ±1〜2°の回転揺れを時間式で提供。
- 方針: `anim.rotation` にサイン波＋減衰を適用、またはシェイクプリセットと連携。
- 実装イメージ: `rotate` フィルタに `angle = deg2rad(amplitude * sin(…))` を埋め込む。アンカーが中央に来るよう事前調整。
- 成果確認: 0.3秒程度の回転揺れがエイリアスなく再生。複数素材で中心ズレが無いか確認。
- 補足: 高速回転時のブラーは `tblend` 併用をオプション化。

### 12. アニメーションプリセット化（YAML一発指定）
- 背景: 頻出動きを毎回式で書くのは非効率。
- 目的: よく使う動きを YAML でプリセット参照し、パラメータのみ上書きできるようにする。
- 方針: `anim: preset: pop_in` のような参照方式を定義。プリセット定義ファイルを `config/animation_presets.yml` に設置。
- 実装イメージ: 起動時にプリセットYAMLをロード→式テンプレにパラメータをバインド→Timelineへ挿入。ホットリロードをサポート。
- 成果確認: `preset=wiggle` などを指定したシーンが期待通り再生。プリセット欠損時はバリデーションエラー。
- 補足: プリセットのバージョニングを記録し、互換性維持のための `version` フィールドを用意。

### 13. マスク/マット・カスタムワイプ
- 背景: 形状に沿った表示/トランジション需要。
- 目的: マスクPNGやマット合成、ロゴ形状ワイプを実現。
- 方針: `alphamerge`/`colorkey`/`format=yuva444p` の組合せで実装。
- 実装イメージ: `fg_overlays[*].mask` や `transitions[*].wipe` を追加し、ルックアップで適用。
- 成果確認: カスタム形状での合成/ワイプが崩れなく動作。

### 14. ローワーサード/テロップ（テンプレ）
- 背景: 名前帯・解説帯の需要。
- 目的: テンプレ＋簡易APIで素早く統一デザインを適用。
- 方針: `lower_third` テンプレを複数同梱、テキスト/色/位置のオプション。
- 実装イメージ: PNGテンプレ合成 or drawtextプリセット化、アニメ入退場（ease）。
- 成果確認: デモ台本で統一感のあるローワーサードが適用。

### 15. ピクチャー・イン・ピクチャー（PIP）
- 背景: 解説/リアクション等での小画面表示。
- 目的: 角丸/影/枠のPIPを簡単指定。
- 方針: PIPレイヤを追加し、枠/シャドウを filter_complex で合成。
- 実装イメージ: `pip: {src, rect, radius, shadow, border}` のスキーマ追加。
- 成果確認: 配置/枠/影のオプションが反映。

### 16. カラオケ風字幕（進行ハイライト）
- 背景: 読み上げ進行に同期した強調表示。
- 目的: 視認性と没入感の向上。
- 方針: 語/モーラ単位のタイムスタンプを用いてハイライトレイヤを生成。
- 実装イメージ: 分割PNG/マスク or `subtitles` フィルタ、タイムラインに進行率を記録。
- 成果確認: 音声とハイライトの誤差 < 100ms。

### 17. BGM ビート検出と自動カット合わせ
- 背景: 音楽の拍にカット/台詞を寄せたい。
- 目的: テンポ感の向上と一体感。
- 方針: オンセット検出→微調整（許容±数百ms）。
- 実装イメージ: librosa等でbeat/onset抽出→台詞開始時刻補正。
- 成果確認: クリックデバッグと視聴で自然な一致。

### 18. SRT/WebVTT の入出力（双方向）
- 背景: 外部ツールとの互換性要求。
- 目的: SRT/ASS/VTT のインポート/エクスポート対応。
- 方針: `Timeline` を拡張して双方向変換を実装。
- 実装イメージ: parser/writer を追加し、CLIで指定可能に。
- 成果確認: 既存ツールとの往復で差分最小。

### 19. プレビュー高速レンダリングモード
- 背景: 調整反復を高速化したい。
- 目的: 低解像度・低ビットレートでのクイック出力。
- 方針: `--preview` で `VideoParams` を縮小、字幕PNGは共通キャッシュ。
- 実装イメージ: 720p/540pプリセット、CRF/ビットレートを軽量化。
- 成果確認: 所要時間が大幅短縮（品質はプレビュー用途）。

### 20. 背景除去/クロマキー（簡易）
- 背景: グリーンバックや静止画の単純除去需要。
- 目的: 破綻の少ない色キー/差分合成を提供。
- 方針: `colorkey`/`chromakey` の適用、差分は限定提供。
- 実装イメージ: `fg_overlays[*].chroma` の拡張、塗り足し/エッジブラーを追加。
- 成果確認: 境界ノイズ・色抜けが許容範囲。

### 21. パーティクル（雨/雪/キラ）プリセット
- 背景: 手軽に演出を強化したい。
- 目的: 軽量素材/手続きでの雨・雪・キラ演出。
- 方針: 既存素材のタイリング/ループ＆色調整をテンプレ化。
- 実装イメージ: `effects[]` に `particles: {type, density, speed, color}` を追加。
- 成果確認: 種別ごとの見た目が安定し負荷が許容内。

### 22. VOICEVOX 音声合成の並列化（スピーカー単位の上限）
- 背景: 今回はAudioが支配的でないが、大規模台本で効果が見込める。
- 目的: スループット向上と安定性（レート制限回避）。
- 方針: `asyncio.Semaphore` による全体/話者別上限、タイムアウト/リトライ調整。
- 実装イメージ: クライアント層で並列制御、メトリクスをログ化。
- 成果確認: 大規模台本で短縮、エラー未増。

### 23. YAMLスキーマ拡張（assets辞書・字幕スタイルテンプレ）
- 背景: パス直書きや冗長なスタイル指定の負担。
- 目的: スキーマの簡素化/可読性向上。
- 方針: assets辞書/スタイルテンプレ参照を追加、`script_loader` で解決。
- 実装イメージ: `assets: {logo: path, ...}` と `subtitle.styles[]` のテンプレ機構。
- 成果確認: 台本の重複削減・編集性向上。

### 24. 自動ポーズ/句読点ルール
- 背景: 句読点での自然な間の需要。
- 目的: 自然な発話テンポの実現。
- 方針: テキスト整形でポーズを挿入、音声生成と同期。
- 実装イメージ: 句読点/記号ごとに既定ポーズ、上書きパラメータ対応。
- 成果確認: 聴感上の自然さ、タイムライン整合。

### 25. サムネ/チャプター自動生成
- 背景: 公開準備の効率化。
- 目的: キーシーン静止画とYouTubeチャプターTXTを自動作成。
- 方針: `Timeline` のシーン境界/台詞見出しから生成。
- 実装イメージ: ffmpegでサムネ抽出、md/txtでチャプター出力。
- 成果確認: 生成物の内容/時刻が妥当。

### 26. プロジェクトテンプレ/テーマ
- 背景: 新規プロジェクト立ち上げの簡略化。
- 目的: スタイル/構成の再利用性向上。
- 方針: `templates/` 整備とCLIスキャフォールド。
- 実装イメージ: 複数テーマの雛形、READMEチュートリアル付き。
- 成果確認: ひな形からの生成が成功。
