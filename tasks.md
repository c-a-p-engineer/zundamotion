# 📋 Zundamotion タスクリスト（優先度順・再整理）

本ファイルは、最新ログを踏まえた改善タスクのみを掲載します（完了済みは削除）。

参照ログ: `logs/20250908_065024_175.log`, `logs/20250902_022808_840.log`, `logs/20250902_023125_440.log`, `logs/20250831_172922_025.log`

最新観測サマリ（2025-09-08 実行）:
- 総所要: 152.68s。内訳: AudioPhase 12.03s (8%) / VideoPhase 117.49s (77%) / BGMPhase 2.61s / FinalizePhase 18.59s。
- GPUエンコードはNVENCを利用できているが、GPUフィルタは無効（`GPU overlay backend=none (cuda=False, opencl_ok=False)`）。スケール/オーバーレイはCPU経路。
- 初期は `clip_workers=6, filter_threads=4` で開始→AutoTuneにより `clip_workers=2, filter_*_threads=2` に抑制。初期過剰並列でスロースタートの形。
- 重いクリップ例: `subtitle_zundamon_*` が 16.8–20.5s/本、`outro_4` が 14.08s。字幕や前景のRGBA合成が重い。
- 結合/コピーは高速（例: `ConcatCopy throughput=80–126MB/s`）。BGM/トランジションも相対的に軽い。


## P1（品質向上を最優先しつつ大幅高速化）

### 01. 並列度の初期化不整合の是正とオートチューニング前倒し（品質）
- 背景: ログ上「VideoRenderer initialized: clip_workers=2」→「VideoPhase started: clip_workers=6」と不整合。直後にAutoTuneで 6→2 へ減衰。
- 目的: 実行開始直後から一貫した並列度で安定動作。無駄な過負荷・スロースタートを回避。
- 方針: 初期化時の `clip_workers` 決定を単一点に集約し、GPU/CPU経路と `nproc` に応じたヒューリスティクスを適用。`filter_threads`/`filter_complex_threads` も同一箇所で決定し、ログに最終値を1度だけ明示。
- 成果確認: 先頭Nクリップの処理時間とCPU使用率のばらつきが縮小し、AutoTuneによる大幅な再設定が発生しない。

### 02. パイプライン計測の拡充（品質）
- 背景: フェーズ合計は出ているが、シーン別/クリップ別のp50/p95やGPU/CPU経路の内訳が見えにくい。
- 目的: ボトルネック特定を容易化。
- 方針: Scene/Clipごとの所要と上位重いクリップTop-N、GPU/CPUフィルタ経路、スレッド/ワーカー設定、AutoTune決定理由をPipeline Summaryへ集計出力。
- 成果確認: 最新ログだけで原因特定と改善効果の定量比較が可能。

### 03. GPUフィルタ経路（overlay_cuda/scale_{cuda|npp})の実装強化と自動選択（高速化・大）
- 背景: 現状はNVENCのみ利用、フィルタはCPU。RGBA合成が支配的でVideoPhaseが77%。
- 目的: スケール/オーバーレイをGPU内で完結しCPU負荷を大幅削減。`hwupload_cuda`→`scale_*`→`overlay_*`→NVENCへ直結、`hwdownload`回避。
- 方針: 起動時スモークテスト（filters列挙で `overlay_cuda` か `scale_npp` を検出）。CUDA失敗時はOpenCL→CPUへ段階フォールバック。環境変数 `HW_FILTER_MODE` で固定可能に。
- 成果確認: `subtitle_zundamon_*` 等の1クリップ当たり所要が 30–60% 以上短縮。VideoPhase総時間の大幅短縮。

### 04. 静的レイヤのシーン前合成（品質/高速化・中）
- 背景: ログ上 `face_overlay_*` の一時生成は再利用されているが、初段の `subtitle_zundamon_*` が依然重い。
- 目的: 行ごとのfilter_complexを簡素化し、重複演算を削減。
- 方針: シーン開始時に背景＋静的前景をベース映像へ事前合成（既設ロジックの適用保証）。適用/未適用と静的レイヤ数をログ化。
- 成果確認: 行クリップ側のフィルタグラフ短縮により、初段クリップ群の所要が顕著に改善。

### 05. 字幕PNGの先行生成・プロセスプール化（高速化・中）
- 背景: 字幕生成は速いが待ち合わせが点在。行数増で効く。
- 目的: VideoPhase の待機削減。
- 方針: `--precache-subtitles` で全行のPNGを先行生成（プロセスプール）。生成統計（p50/p95）をログに出力。
- 成果確認: プレビュー/本番双方でVideoPhaseの待ちが減る。

### 06. 字幕フォントのフェイルセーフ（品質）
- 背景: 端末差でフォント不在時に失敗リスク。
- 方針: フォント解決にフォールバックチェーンを導入し、発生時に警告ログで通知。
- 成果確認: 不在フォントでもレンダが続行し、視認性が保たれる。


## P2（改善・将来・機能追加）

### 01. VOICEVOX 音声合成の並列化（スピーカー単位の上限）
- 背景: 今回ログではAudioPhaseは8%と支配的ではないが、行数が多い脚本で効く改善。
- 目的: スループット向上と安定性（レート制限回避）。
- 方針: `asyncio.Semaphore` による全体/話者別上限、タイムアウト/リトライ調整、並列度統計のログ化。
- 成果確認: 大規模台本での短縮とエラー無増加。

### 01. 口パク（音素/ビセーム）最小実装
- 機能: 音素/ビセーム推定に基づき口形 PNG を時間同期で切替。
- 背景: 現状は最小版（音量しきい値）を実装済。精度向上の余地あり。
- ゴール: 音素ベースで自然な口形遷移。
- 実装案: pyopenjtalk 等で音素列→ビセーム時系列→`face_anim` 注入。
- 確認方法: デバッグ可視化用に mouth state をログ/タイムライン出力。

### 02. フィルター/エフェクトのプリセット
- 機能: ぼかし/ビネット/色調/LUT/ズームパン等を行/シーン単位で適用。
- 背景: 表現力の拡充要望。
- ゴール: 既存スキーマ最小拡張で汎用エフェクト適用。
- 実装案: `line_config.effects[]` を追加し filter_complex に合成。RGBA 無しなら GPU backend を優先。
- 確認方法: 比較用ゴールデン映像と目視/ヒストグラム比較。

### 03. トランジション拡充（テンプレ化）
- 機能: スライド/ワイプ/グリッチ等のテンプレ追加。
- 背景: xfade 以外の需要。
- ゴール: 種類/パラメータ化を `apply_transition` に統合。
- 実装案: 種別ごとに filter_complex を実装、CLI/スキーマから選択。
- 確認方法: サンプル台本で連結動作と境界の音切れ無しを確認。

### 04. カラオケ風字幕
- 機能: 読み上げ進行に合わせてテキストをハイライト。
- 背景: 表現の拡張。
- ゴール: 視認性と同期精度の確保。
- 実装案: 分割 PNG/マスクレイヤ or `subtitles` フィルタ併用。
- 確認方法: 音声とハイライトの誤差 < 100ms。

### 05. ピクチャー・イン・ピクチャー（PIP）
- 機能: 任意の動画/画像を枠付きで重畳表示。
- 背景: 解説/ゲーム実況等の需要。
- ゴール: 角丸/影/枠のオプション提供。
- 実装案: 追加 overlay チェーンと簡易 UI スキーマ。
- 確認方法: 位置/サイズ/枠のオプションが効くこと。

### 06. BGM ビート検出と自動カット合わせ
- 機能: BGM の拍に台詞/カットを寄せる。
- 背景: テンポ感の向上。
- ゴール: 過剰な調整を避けつつ自然な合わせ。
- 実装案: オンセット検出→開始時刻微調整。
- 確認方法: クリック音デバッグとタイムライン比較。

### 07. SRT/WebVTT の入出力
- 機能: 外部字幕のインポート/エクスポート。
- 背景: 互換性確保。
- ゴール: 双方向変換を提供。
- 実装案: `Timeline` 拡張、parser/writer 追加。
- 確認方法: 既存ツールとの相互運用テスト。

### 08. プレビュー高速レンダリングモード
- 機能: 低解像度/低ビットレートでのクイックプレビュー。
- 背景: 繰り返し調整の高速化。
- ゴール: 本番設定に影響を与えずプレビューのみ高速化。
- 実装案: `--preview` で `VideoParams` を縮小、字幕PNGは共通キャッシュ。
- 確認方法: プレビュー所要が大幅短縮されること。

### 09. 背景除去/クロマキー（簡易）
- 機能: 立ち絵/動画の背景透過/色キー除去。
- 背景: グリーンバック素材の活用。
- ゴール: 破綻の少ない単純除去。
- 実装案: `colorkey`/`chromakey`/差分合成の適用。
- 確認方法: 境界ノイズ/色抜けの目視確認。

### 10. キーフレーム的パラメトリックアニメ
- 機能: 位置/スケール/不透明度の時間変化。
- 背景: 表現力向上。
- ゴール: シンプルな指定で自然な動き。
- 実装案: 簡易キーフレーム→補間→ filter_complex 反映。
- 確認方法: モーション軌跡のログ/動画で検証。

### 11. プロジェクトテンプレ/テーマ
- 機能: 構成/スタイルのテンプレ化。
- 背景: セットアップ時間短縮。
- ゴール: 再利用性向上。
- 実装案: `templates/` 整備と CLI スキャフォールド。
- 確認方法: ひな形からの生成が成功すること。

### 12. 吹き出し/ネームプレート（話者UI）
- 機能: キャラ名入りの吹き出し/プレート表示。
- 背景: 話者識別の明確化。
- ゴール: 視認性と読みやすさ向上。
- 実装案: 吹き出しPNGテンプレ＋テキスト合成 or 字幕拡張。
- 確認方法: レイアウト崩れや被りがないこと。

### 13. YAMLスキーマ拡張（assets辞書・字幕スタイルテンプレ）
- 機能: パス直書きを避け、テンプレ/辞書参照を可能に。
- 背景: 冗長性/編集コストの削減。
- ゴール: スキーマの簡素化と可読性向上。
- 実装案: `script_loader` でテンプレ展開・検証を追加。
- 確認方法: 既存・新形式の双方で正しく解決されること。

### 14. 自動ポーズ/句読点ルール
- 機能: 句読点等で自動ポーズを挿入。
- 背景: 自然な発話テンポ。
- ゴール: 過剰/不足のないポーズ。
- 実装案: テキスト整形→無音区間挿入。
- 確認方法: タイムライン/耳での確認。

### 15. サムネ/チャプター自動生成
- 機能: キーシーンの静止画・YouTube チャプターTXT出力。
- 背景: 投稿準備の効率化。
- ゴール: 最小操作で公開可。
- 実装案: `Timeline` から境界抽出→ ffmpeg でサムネ生成。
- 確認方法: 生成物の内容/時刻が妥当であること。
