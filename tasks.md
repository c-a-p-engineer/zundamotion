# 📋 Zundamotion タスクリスト（優先度順・再整理）

本ファイルは、最新ログを踏まえた改善タスクを優先度順に記載します（完了済みは削除）。
各タスクは「背景 / 目的 / 方針 / 実装イメージ / 成果確認」の形式で詳細化します。

参照ログ（最新→古い順）: `logs/20250911_062724_974.log`, `logs/20250910_045352_758.log`, `logs/20250910_041524_580.log`

最新観測サマリ（2025-09-11 実行）:
- 総所要: 160.19s。内訳: AudioPhase 8.46s / VideoPhase 133.79s / BGMPhase 2.17s / FinalizePhase 13.52s。
- ボトルネック: VideoPhase（約83%）。`Filter path usage: cuda_overlay=0, opencl_overlay=0, gpu_scale_only=21, cpu=0`。
  - 背景スケールはGPUのみ、合成はCPU overlay（ハイブリッド）。
  - Scene Base生成が「静的オーバーレイ=0」でも各シーン10–15s程度発生。
- FFmpegスレッド自動調整: nproc=12 → `clip_workers=3`, `threads=4`, `filter_threads=2`。
- ConcatCopyは高速（~170MB/s）。


## P1（品質向上・高速化）

### 00. FFmpeg を CUDAフィルタ入りビルドへ切替（環境整備）
- 背景: 現状 `overlay_cuda` が不可のため、合成がCPU支配で VideoPhase が長い。
- 目的: `overlay_cuda`/`scale_cuda`/`scale_npp` を有効化し、GPU内で合成→NVENCへ直接渡して往復コストを削減。
- 方針: DevContainer/DockerでCUDA対応FFmpegをビルドまたは採用（`--enable-cuda-nvcc --enable-libnpp --enable-nonfree`）。スモークテストとフィルタ一覧をログ出力し自動判定を強化。
- 実装イメージ: `.devcontainer/Dockerfile.gpu` 切替、起動時に `ffmpeg -filters`/`-buildconf` を1回だけログへ。`utils/ffmpeg_hw.py` で `set_hw_filter_mode` とスモークの分岐を調整。
- 成果確認: ログに `cuda_overlay>0` が出現し、VideoPhase時間が大幅短縮。

### 01. Scene Base の無駄レンダ回避（静的オーバーレイ0件時はスキップ）
- 背景: `generated base with 0 static overlay(s)` でも各シーン10–15sのベース生成が発生。
- 目的: 静的前景が無いケースでのベース生成を省略し、行クリップの合成へ直行。
- 方針: Sceneごとに「静的前景=0」かつ「背景が正規化済み」の条件でベース生成をバイパス。
- 実装イメージ: `video_phase.py` のベース生成分岐にガードを追加。バイパス時は行合成の背景入力を正規化済みパスに差し替え。
- 成果確認: ベース生成時間=0s、VideoPhase合計の短縮（シーン数×10–15s）。

### 02. 既存最適化の効果検証＆チューニング（VideoPhase短縮）
- 背景: 字幕PNGプリキャッシュ/キャラPNG事前スケール/スケーラ最適化/FPSフィルタ抑制により改善中。
- 目的: 閾値・プリセットの最適化と回帰防止。
- 方針: `precache_min_lines`/`CHAR_ALPHA_THRESHOLD`/`scene_base_min_lines`/`allow_opencl_overlay_in_cpu_mode` を調整、遅い行Top5を継続計測。
- 実装イメージ: 既存設定とヒューリスティクスの調整値を `templates/config.yaml` とコード定数で管理、ログに比較結果を出力。
- 成果確認: VideoPhase 133.79sからの更なる5–10%短縮。

### 03. OpenCL overlay 安定性検証（オプトイン）
- 背景: CPUモードでも OpenCL overlay を限定的に許可するオプトインがあるが、環境差が大きい。
- 目的: 対象環境での安定性と速度向上を検証し既定値の是非を判断。
- 方針: `video.allow_opencl_overlay_in_cpu_mode: true` の計測、失敗時フォールバックの動作確認。
- 実装イメージ: スモーク通過時のみ `overlay_opencl` を使用。障害検知で一度だけ診断出力→CPUへバックオフ。
- 成果確認: ログ `opencl_overlay>0` かつ VideoPhase短縮、エラー未増。


## P2（改善・将来・機能追加）

### 01. 画像オーバーレイにも前景フィルタ適用（エフェクト統一）
- 背景: 現状の前景フィルタは動画中心で、静止画像（PNG）に未適用の効果がある。
- 目的: 動画/画像問わず同じエフェクト指定で表現を統一。
- 方針: `fg_overlays[*].effects[]` を導入。画像は `format=rgba`＋必要時 `fps` を与え、filter_complexへ統合。
- 実装イメージ: `effects[]` に `blur/vignette/eq/hue/curves/unsharp/lut3d/zoompan/rotate` を段階実装、順序制御に対応。
- 成果確認: 同一YAMLで動画/画像ともに効果適用、回帰テストOK。

### 02. 複数キャラクター同時配置（レイアウト・Z順・自動配置）
- 背景: 2人/3人ショットなど同時表示ニーズ。
- 目的: `characters[]` を同時合成し、Z順・レイアウトを簡便に指定。
- 方針: `z`/`anchor`/`layout(two_shot/three_shot)`/`safe_margin` を拡張。
- 実装イメージ: テンプレレイアウト（左右/三分割）と自動スケール、重なり回避ロジックを実装。
- 成果確認: 被り・はみ出しなしで配置、Z順が意図通り。

### 03. アニメーション基盤（キーフレーム/式/プリセット）
- 背景: キャラクターや前景に揺れ/スウェイ/ズーム等の動きを付けたい。
- 目的: `position/scale/rotate/opacity` をキーまたは時間式で制御し、プリセットも提供。
- 方針: `anim` ブロック導入（keys or expr）。easing、sin/cos、減衰などをサポート。
- 実装イメージ: FFmpeg式を `overlay/rotate/scale` にバインド。`shake/sway/bob/jiggle` のプリセット展開。
- 成果確認: デモYAMLで滑らかな動作、プレビュー/本番で一致。

### 04. カメラワーク（パン/ズーム/ティルトの擬似）
- 背景: 静止背景でも動きを演出したい。
- 目的: シーン全体に擬似的なカメラ移動を適用。
- 方針: 背景に `zoompan/scale` と `crop` を組み合わせ、`anim` 同等の指定で制御。
- 実装イメージ: 安全枠（overscan）と境界処理、イージング対応。
- 成果確認: イントロ/アウトロで滑らかなパン・ズームが適用。

### 05. マスク/マット・カスタムワイプ
- 背景: 形状に沿った表示/トランジション需要。
- 目的: マスクPNGやマット合成、ロゴ形状ワイプを実現。
- 方針: `alphamerge`/`colorkey`/`format=yuva444p` の組合せで実装。
- 実装イメージ: `fg_overlays[*].mask` や `transitions[*].wipe` を追加し、ルックアップで適用。
- 成果確認: カスタム形状での合成/ワイプが崩れなく動作。

### 06. ローワーサード/テロップ（テンプレ）
- 背景: 名前帯・解説帯の需要。
- 目的: テンプレ＋簡易APIで素早く統一デザインを適用。
- 方針: `lower_third` テンプレを複数同梱、テキスト/色/位置のオプション。
- 実装イメージ: PNGテンプレ合成 or drawtextプリセット化、アニメ入退場（ease）。
- 成果確認: デモ台本で統一感のあるローワーサードが適用。

### 07. ピクチャー・イン・ピクチャー（PIP）
- 背景: 解説/リアクション等での小画面表示。
- 目的: 角丸/影/枠のPIPを簡単指定。
- 方針: PIPレイヤを追加し、枠/シャドウを filter_complex で合成。
- 実装イメージ: `pip: {src, rect, radius, shadow, border}` のスキーマ追加。
- 成果確認: 配置/枠/影のオプションが反映。

### 08. カラオケ風字幕（進行ハイライト）
- 背景: 読み上げ進行に同期した強調表示。
- 目的: 視認性と没入感の向上。
- 方針: 語/モーラ単位のタイムスタンプを用いてハイライトレイヤを生成。
- 実装イメージ: 分割PNG/マスク or `subtitles` フィルタ、タイムラインに進行率を記録。
- 成果確認: 音声とハイライトの誤差 < 100ms。

### 09. BGM ビート検出と自動カット合わせ
- 背景: 音楽の拍にカット/台詞を寄せたい。
- 目的: テンポ感の向上と一体感。
- 方針: オンセット検出→微調整（許容±数百ms）。
- 実装イメージ: librosa等でbeat/onset抽出→台詞開始時刻補正。
- 成果確認: クリックデバッグと視聴で自然な一致。

### 10. SRT/WebVTT の入出力（双方向）
- 背景: 外部ツールとの互換性要求。
- 目的: SRT/ASS/VTT のインポート/エクスポート対応。
- 方針: `Timeline` を拡張して双方向変換を実装。
- 実装イメージ: parser/writer を追加し、CLIで指定可能に。
- 成果確認: 既存ツールとの往復で差分最小。

### 11. プレビュー高速レンダリングモード
- 背景: 調整反復を高速化したい。
- 目的: 低解像度・低ビットレートでのクイック出力。
- 方針: `--preview` で `VideoParams` を縮小、字幕PNGは共通キャッシュ。
- 実装イメージ: 720p/540pプリセット、CRF/ビットレートを軽量化。
- 成果確認: 所要時間が大幅短縮（品質はプレビュー用途）。

### 12. 背景除去/クロマキー（簡易）
- 背景: グリーンバックや静止画の単純除去需要。
- 目的: 破綻の少ない色キー/差分合成を提供。
- 方針: `colorkey`/`chromakey` の適用、差分は限定提供。
- 実装イメージ: `fg_overlays[*].chroma` の拡張、塗り足し/エッジブラーを追加。
- 成果確認: 境界ノイズ・色抜けが許容範囲。

### 13. パーティクル（雨/雪/キラ）プリセット
- 背景: 手軽に演出を強化したい。
- 目的: 軽量素材/手続きでの雨・雪・キラ演出。
- 方針: 既存素材のタイリング/ループ＆色調整をテンプレ化。
- 実装イメージ: `effects[]` に `particles: {type, density, speed, color}` を追加。
- 成果確認: 種別ごとの見た目が安定し負荷が許容内。

### 14. VOICEVOX 音声合成の並列化（スピーカー単位の上限）
- 背景: 今回はAudioが支配的でないが、大規模台本で効果が見込める。
- 目的: スループット向上と安定性（レート制限回避）。
- 方針: `asyncio.Semaphore` による全体/話者別上限、タイムアウト/リトライ調整。
- 実装イメージ: クライアント層で並列制御、メトリクスをログ化。
- 成果確認: 大規模台本で短縮、エラー未増。

### 15. YAMLスキーマ拡張（assets辞書・字幕スタイルテンプレ）
- 背景: パス直書きや冗長なスタイル指定の負担。
- 目的: スキーマの簡素化/可読性向上。
- 方針: assets辞書/スタイルテンプレ参照を追加、`script_loader` で解決。
- 実装イメージ: `assets: {logo: path, ...}` と `subtitle.styles[]` のテンプレ機構。
- 成果確認: 台本の重複削減・編集性向上。

### 16. 自動ポーズ/句読点ルール
- 背景: 句読点での自然な間の需要。
- 目的: 自然な発話テンポの実現。
- 方針: テキスト整形でポーズを挿入、音声生成と同期。
- 実装イメージ: 句読点/記号ごとに既定ポーズ、上書きパラメータ対応。
- 成果確認: 聴感上の自然さ、タイムライン整合。

### 17. サムネ/チャプター自動生成
- 背景: 公開準備の効率化。
- 目的: キーシーン静止画とYouTubeチャプターTXTを自動作成。
- 方針: `Timeline` のシーン境界/台詞見出しから生成。
- 実装イメージ: ffmpegでサムネ抽出、md/txtでチャプター出力。
- 成果確認: 生成物の内容/時刻が妥当。

### 18. プロジェクトテンプレ/テーマ
- 背景: 新規プロジェクト立ち上げの簡略化。
- 目的: スタイル/構成の再利用性向上。
- 方針: `templates/` 整備とCLIスキャフォールド。
- 実装イメージ: 複数テーマの雛形、READMEチュートリアル付き。
- 成果確認: ひな形からの生成が成功。
