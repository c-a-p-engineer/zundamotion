# 📋 Zundamotion 開発タスクリスト

## 🚨 P0（必須改善）

### 1. 動画サイズ指定（縦横解像度）

*   **詳細**:
    *   出力動画の解像度（例: 1920x1080, 1080x1920）とアスペクト比（例: 16:9, 9:16, 1:1）を、台本YAMLの `meta` セクションおよびCLI引数から指定できるようにする。
    *   指定された解像度に合わせて、背景動画/画像、キャラクター画像、字幕の表示位置とサイズを自動的に調整する。
*   **背景**:
    *   現状は1280x720固定であり、YouTube Shorts (9:16) や正方形 (1:1) 動画など、多様なプラットフォームに対応できない。
    *   ユーザーが柔軟に動画サイズを制御できるようにする必要がある。
*   **ゴール**:
    *   ユーザーがYAMLまたはCLIで動画の解像度とアスペクト比を自由に設定でき、それに応じて全ての視覚要素が適切にスケーリング・配置される。
*   **実装イメージ**:
    *   **YAML**:
        ```yaml
        meta:
          resolution: "1080x1920" # または "1920x1080" など
          aspect_ratio: "9:16"    # または "16:9", "1:1" など
        ```
    *   **CLI**: `--resolution 1080x1920 --aspect-ratio 9:16` (または `--ratio 9:16` のようなショートハンド)
    *   **内部**:
        *   `config` オブジェクトに `resolution` と `aspect_ratio` を追加。
        *   `VideoRenderer` の初期化時にこれらの値を使用し、FFmpegコマンドの `scale` フィルターに適用。
        *   キャラクターや字幕のオーバーレイ位置計算 (`calculate_overlay_position`) に、動的な動画サイズを考慮させる。
        *   `SubtitleGenerator` も動画サイズに応じて字幕のフォントサイズや位置を調整できるようにする。

## ⚡ P1（演出・効率）

### 2. 複数キャラ掛け合い & ワイプ表示

*   **詳細**:
    *   台本YAMLで複数のキャラクターを同時に表示し、左右分割レイアウトやワイプ表示などのプリセットレイアウトを簡単に指定できるようにする。
    *   各キャラクターの表示位置（例: `left`, `right`, `center`, `top_left` など）を抽象化し、内部で適切なFFmpegオーバーレイ座標に変換する。
*   **背景**:
    *   現状は1キャラ中心の表示であり、解説動画や茶番など、複数キャラの対話が頻繁に行われるコンテンツに対応できない。
    *   より表現豊かな動画作成のために、複数キャラの同時表示は必須。
*   **ゴール**:
    *   ユーザーがYAMLで複数キャラの同時表示とレイアウトを直感的に指定でき、FFmpegがそれに応じて動画を生成する。
*   **実装イメージ**:
    *   **YAML**:
        ```yaml
        - char: zundamon
          text: "こんにちは！"
          position: left # プリセット位置
        - char: metan
          text: "元気だね！"
          position: right # プリセット位置
        ```
    *   **内部**:
        *   `VideoRenderer` 内で、`characters_config` の `position` にプリセット値が指定された場合、動画の解像度に基づいて具体的なx, y座標を計算するロジックを追加。
        *   必要に応じて、`overlay` フィルターの組み合わせや、`hstack`/`vstack` などのフィルターを動的に生成する。

### 3. キャラアニメーション（入退場・動き）

*   **詳細**:
    *   キャラクターの登場・退場時に、スライドイン、フェードイン、ズームインなどのアニメーション効果をYAMLで指定できるようにする。
    *   アニメーションの期間 (`dur`) や方向 (`from`) も指定可能にする。
*   **背景**:
    *   キャラクターが棒立ちで静的に表示されるだけでは単調であり、動画の表現力が低い。
    *   動きを加えることで、視聴者のエンゲージメントを高め、よりプロフェッショナルな印象を与える。
*   **ゴール**:
    *   キャラクターが動的に登場・退場し、動画に活気と視覚的な魅力を加える。
*   **実装イメージ**:
    *   **YAML**:
        ```yaml
        - char: zundamon
          text: "こんにちは！"
          effects:
            - type: slide_in
              from: left
              dur: 0.5
            - type: fade_out
              dur: 0.3
        ```
    *   **内部**:
        *   `VideoRenderer` の `render_clip` メソッド内で、`characters_config` に `effects` が含まれる場合、FFmpegの `fade`, `zoompan`, `setpts`, `crop`, `pad` などのフィルターを組み合わせてアニメーションを実装。
        *   キャラクターのライフサイクル（登場、表示、退場）を管理するロジックを追加。

### 4. シナリオ記法（二段構え）

*   **詳細**:
    *   初心者向けのシンプルな記法と、上級者向けの詳細な制御を両立させる。
    *   シンプルな記法ではデフォルト値を活用し、詳細な記法では全てのパラメータを明示的に指定できるようにする。
*   **背景**:
    *   ユーザーのスキルレベルやニーズに応じて、スクリプトの記述方法を柔軟に選択できるようにすることで、使いやすさと表現力の両方を確保する。
*   **ゴール**:
    *   ユーザーが簡単に動画を作成できる一方で、必要に応じて高度なカスタマイズも行えるようになる。
*   **実装イメージ**:
    *   **シンプル**:
        ```yaml
        - char: zundamon
          text: "こんにちは！"
        ```
    *   **詳細**:
        ```yaml
        - char: zundamon
          text: "こんにちは！"
          expression: happy
          position: {x: "W*0.2", y: "H*0.8"} # 詳細な座標指定
          se:
            path: se/pon.wav
            at: line_end - 0.2s # 相対トリガー
          effects:
            - type: slide_in
              from: left
              dur: 0.5
        ```
    *   **内部**:
        *   `script_loader.py` で、YAMLのパース時にデフォルト値を適用するロジックを強化。
        *   各コンポーネント（`AudioGenerator`, `VideoRenderer`, `SubtitleGenerator` など）が、渡された `line_config` から必要な情報を適切に抽出し、不足している場合はデフォルト値を使用する。

### 5. SE相対トリガー

*   **詳細**:
    *   効果音 (`se`) の再生タイミングを、セリフの開始 (`line_start`) や終了 (`line_end`) を基準とした相対的な時間で指定できるようにする。
    *   例: `at: line_end - 0.2s`
*   **背景**:
    *   効果音はセリフの特定の瞬間に合わせて再生されることが多く、固定秒数での指定では調整が煩雑になる。
    *   より直感的で柔軟な効果音配置を可能にする。
*   **ゴール**:
    *   ユーザーがセリフのタイミングに連動した効果音を簡単に配置できる。
*   **実装イメージ**:
    *   **YAML**:
        ```yaml
        se:
          path: se/pon.wav
          at: line_end - 0.2s
        ```
    *   **内部**:
        *   `AudioPhase` または `Timeline` クラス内で、`at` フィールドの値をパースし、`line_start` や `line_end` を基準とした絶対時間に変換するロジックを追加。
        *   FFmpegの `adelay` フィルターや `atrim` フィルターを組み合わせて、正確なタイミングでSEをミックスする。

### 6. 素材リゾルバ

*   **詳細**:
    *   動画生成の実行前に、スクリプト内で参照されている全ての素材ファイル（背景、キャラクター画像、SE、BGM、挿入メディアなど）の存在をチェックし、不足している場合は警告メッセージを表示する。
*   **背景**:
    *   実行途中で「ファイルがない」というエラーで処理が中断されるのは非効率的であり、ユーザー体験を損なう。
    *   事前に問題を特定し、ユーザーに修正を促すことで、スムーズな動画生成を支援する。
*   **ゴール**:
    *   動画生成の安定性を向上させ、ユーザーが素材の不足に早期に気づけるようにする。
*   **実装イメージ**:
    *   **内部**:
        *   `run_generation` 関数内で、`load_script_and_config` の後に、新しい `AssetResolver` クラスまたは関数を呼び出す。
        *   `AssetResolver` は、`config` オブジェクトとスクリプトを走査し、全てのファイルパスを抽出。
        *   `Path.exists()` を使用して各ファイルの存在を確認し、不足している場合は `logger.warning` で出力。

## 🌱 P2（将来拡張）

### 7. YouTube Shorts自動変換

*   **詳細**:
    *   既存の16:9の横動画を、YouTube Shortsに適した9:16の縦動画に自動的にリフレーミングする機能。
    *   リフレーミング時に、キャラクターや字幕の位置を自動的に中央に寄せるなど、縦動画に最適化された配置に補正する。
*   **背景**:
    *   既存のコンテンツをYouTube Shortsとして再利用したいという需要が高まっている。
    *   手動での変換作業は手間がかかるため、自動化することで効率を向上させる。
*   **ゴール**:
    *   ユーザーが簡単なCLIオプションやYAML設定で、横動画を縦動画に変換し、YouTube Shortsとして公開できる。
*   **実装イメージ**:
    *   **CLI**: `--profile yt_shorts`
    *   **内部**:
        *   `VideoRenderer` に、特定のプロファイル（例: `yt_shorts`）が指定された場合に、動画の解像度とアスペクト比を自動的に設定し、キャラクターや字幕のデフォルト位置を調整するロジックを追加。
        *   FFmpegの `crop` や `pad` フィルターを組み合わせてリフレーミングを実現。

### 8. 拡張トランジション

*   **詳細**:
    *   シーン間の切り替えに、フェード以外の `wipe`, `slide`, `dissolve` などの多様なトランジション効果をYAMLで指定できるようにする。
*   **背景**:
    *   現状のフェードのみでは表現が単調であり、動画の視覚的な魅力を高めるために、より多くのトランジションオプションが必要。
*   **ゴール**:
    *   ユーザーがシーン間の切り替えをよりクリエイティブに制御し、動画の品質を向上させる。
*   **実装イメージ**:
    *   **YAML**:
        ```yaml
        - scene: scene1
          ...
          transition: wipeleft # 次のシーンへのトランジション
        - scene: scene2
          ...
        ```
    *   **内部**:
        *   `FinalizePhase` または `VideoRenderer` の `concat_clips` メソッドを拡張し、FFmpegの `xfade` フィルターやその他のトランジションフィルターを適用する。
        *   各トランジションタイプに対応するFFmpegコマンドオプションを定義。

### 9. 自動サムネイル出力

*   **詳細**:
    *   動画生成完了後、動画から代表的なフレームをキャプチャし、その上にタイトル文字などを合成してサムネイル画像を自動的に出力する機能。
*   **背景**:
    *   YouTubeなどのプラットフォームでは、魅力的なサムネイルが動画のクリック率に大きく影響する。
    *   手動でのサムネイル作成は手間がかかるため、自動化することで運用効率を向上させる。
*   **ゴール**:
    *   動画生成と同時に、YouTube運用に必要なサムネイルが自動的に生成される。
*   **実装イメージ**:
    *   **内部**:
        *   `FinalizePhase` の後に、新しい `ThumbnailGenerator` クラスまたは関数を追加。
        *   FFmpegの `select` フィルター (`select=gt(scene,0.4)`) を使用して代表フレームを抽出し、`drawtext` フィルターでタイトル文字を合成。
        *   出力パスは設定ファイルで指定可能にする。

### 10. PyPI / Docker / CI整備

*   **詳細**:
    *   Python Package Index (PyPI) への公開を可能にするための `setup.py` または `pyproject.toml` の整備。
    *   DockerコンテナとしてZundamotionを実行できるようにするための `Dockerfile` の作成。
    *   GitHub Actionsなどを用いた継続的インテグレーション (CI) 環境の構築（自動テスト、ビルド、デプロイ）。
*   **背景**:
    *   Zundamotionをオープンソースプロジェクトとして広く利用してもらうためには、導入の容易さと再現性が不可欠。
    *   CIを導入することで、コード品質の維持と開発効率の向上を図る。
*   **ゴール**:
    *   `pip install zundamotion` で簡単にインストールでき、Docker環境で安定して動作し、コード変更が自動的にテストされる。
*   **実装イメージ**:
    *   `setup.py` または `pyproject.toml` の作成。
    *   `Dockerfile` の作成（Python環境、FFmpeg、VOICEVOX連携など）。
    *   `.github/workflows/main.yml` の作成（テスト、ビルド、Dockerイメージのプッシュなど）。

### 11. タスク出力（JSON/CSVログ）

*   **詳細**:
    *   動画生成プロセス中に、各シーンで使用された素材（背景、キャラクター、音声、SE、BGMなど）、その開始時間、終了時間などの詳細情報をJSONまたはCSV形式でログとして出力する機能。
*   **背景**:
    *   動画の構成要素やタイミングを外部ツールで分析したり、デバッグしたりする際に、詳細なログが必要となる。
    *   特に複雑な動画の場合、どの素材がどこで使われたかを一目で確認できると効率的。
*   **ゴール**:
    *   動画の生成過程が透過的になり、外部ツールとの連携やデバッグが容易になる。
*   **実装イメージ**:
    *   **JSON**:
        ```json
        {
          "scene1": {
            "bg": "street.png",
            "voice": "zundamon",
            "start": "0:00",
            "end": "0:12",
            "characters": [
              {"name": "zundamon", "expression": "default", "start": "0:00", "end": "0:12"}
            ],
            "se": [
              {"path": "se/pon.wav", "at": "0:05"}
            ]
          }
        }
        ```
    *   **内部**:
        *   `Timeline` クラスを拡張し、各イベント（シーン開始、ライン開始、素材使用など）を詳細なデータ構造で記録できるようにする。
        *   `Timeline` に `save_as_json` メソッドを追加し、構造化されたログを出力。

### 12. Viseme対応 & VRM連動（長期）

*   **詳細**:
    *   VOICEVOXの音素データを利用して、キャラクターの口形（Viseme）を自動的に生成し、より自然なリップシンクを実現する。
    *   将来的には、VRMモデルと連携し、3Dキャラクターのモーション制御を可能にする。
*   **背景**:
    *   現在のキャラクター表示は静的であり、音声と口形の連動がないため、不自然さが残る。
    *   3Dキャラクター対応は、Zundamotionを「総合映像エンジン」へと発展させるための重要なステップ。
*   **ゴール**:
    *   キャラクターのリップシンクが自然になり、動画のリアリティと表現力が大幅に向上する。
    *   3Dキャラクターを動画に組み込むことが可能になる。
*   **実装イメージ**:
    *   **内部**:
        *   `AudioPhase` でVOICEVOXから音素データを取得し、各音素に対応する口形画像をマッピングするロジックを追加。
        *   `VideoRenderer` で、音声のタイミングに合わせてキャラクターの口形画像を切り替える。
        *   VRM連携には、外部ライブラリやAPI（例: UniVRM, VMCProtocol）との統合が必要となるため、別途モジュールを設計。
