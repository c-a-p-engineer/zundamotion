# 📋 Zundamotion タスクリスト

最新の進捗に合わせてタスクをカテゴリ別に整理しました。
全タスクは「背景 / 目的 / アプローチ / 検証 / 備考」の順で要点を統一しました。

## 🧱 基礎仕様 & レイアウト

- **画像表示方式の基本仕様**
  - 背景: 画像表示の持続条件が曖昧で、意図しない残留や冗長指定が発生している。
  - 目的: 背景・立ち絵は持続表示、アイコン等は短命表示といった標準挙動を定義して記述負荷を下げる。
  - アプローチ: `show/hide` DSL を整理し、`duration: one_shot` など短命指定を追加。Timeline ローダで enter/exit を生成し、バリデーションを強化する。
  - 検証: シナリオテストで持続表示・手動 `hide`・`one_shot` の各挙動が期待通りになること。誤指定で警告が出ること。
  - 備考: YAML スキーマに糖衣構文（`overlay: {src, one_shot: true}`）を追加。

- **複数キャラクター同時配置**
  - 背景: ツーショット／スリーショットなど同時表示ニーズが増えている。
  - 目的: `characters[]` による複数配置時に Z 順・レイアウト・安全マージンを簡潔に制御する。
  - アプローチ: `layout(two_shot/three_shot)`、`z`、`safe_margin` を追加し、自動スケールと重なり回避ロジックを実装する。
  - 検証: 2〜3キャラ同時のデモで被りやはみ出しがなく、意図した Z 順で描画されること。

- **アンカー基準点指定**
  - 背景: 足元・中央など素材ごとに合わせたい基準が異なる。
  - 目的: レイヤごとに `anchor` を指定し、座標式と連動できるようにする。
  - アプローチ: `anchor: {x: center|left|right, y: top|center|bottom}` をスキーマに追加し、メタ情報からオフセットを計算して `overlay/scale` に適用する。
  - 検証: 足元基準での立ち位置調整や中央基準ポップアップがブレなく描画されること。
  - 備考: 将来のパララックス対応のためアンカー情報を Timeline メタデータに保持。

## 🧰 アニメーション基盤 / プリセット

- **アニメーション基盤（DSL / 補間共通化）**
  - 背景: 個別実装が増え、式やキーフレームの再利用が難しい。
  - 目的: `position/scale/rotate/opacity` を統一 DSL で記述できるようにし、エフェクトカテゴリ間で共通化する。
  - アプローチ: `anim: {expr|keys}` を導入し、線形・イージング・サイン波のユーティリティとバリデータを整備する。
  - 検証: デモシーンで x/y/scale/opacity の複合アニメが DSL で期待通り動作し、失敗時は安全フォールバックする。

- **スケール時間式サポート**
  - 背景: 素材のズーム演出を滑らかに制御したい要望が多い。
  - 目的: `scale` フィルタに時間式を適用してズームイン・アウトを実現する。
  - アプローチ: `anim.scale` に lerp/ease 式を渡せるようにし、`scale` の `w/h` に時間式を埋め込む。上限超えを検出するガードを追加する。
  - 検証: 3 秒で 1.0→1.2 倍するテストで破綻がなく、超解像時に警告が出ること。
  - 備考: GPU `scale_npp` などハードウェアパスでの互換性も確認。

- **パン（左右上下移動）制御**
  - 背景: キャラクターやテキストを滑らかに画面内移動させたい。
  - 目的: `overlay` の `x/y` に時間式を適用し、直線移動やスイングを提供する。
  - アプローチ: `anim.position` で座標式を生成し、アンカー補正後に `clamp` を適用。グループ ID で同時開始を同期する。
  - 検証: 左端から中央へ 3 秒移動させるデモでジャダーやはみ出しが無いこと。

- **Ken Burns（背景ズーム＋パン複合）**
  - 背景: 静止背景でも奥行きと動きを出したい。
  - 目的: 背景素材にズーム・パン・ティルトを同時適用するプリセットを提供する。
  - アプローチ: `background.anim` にズーム/パン式を定義し、`scale → crop → overlay` のチェーンで overscan を確保する。
  - 検証: 「静止→ゆるズーム→右上パン」のサンプルでエッジ切れや黒帯が出ないこと。

- **ポップイン/アウト（登場・退場テンプレ）**
  - 背景: キャラクターの出入りを視覚的に印象付けたい。
  - 目的: 登場時の 0.9→1.0 倍、退場時の縮小＋フェードをプリセット化する。
  - アプローチ: `anim.presets.pop_in/pop_out` を用意し、`scale` と `opacity` を連携させる。
  - 検証: 複数キャラの登場・退場が競合なく適用されること。
  - 備考: 音声キューと同期できるよう `cue` 連携仕様を定義する。

- **回転揺れ（rot_shake）**
  - 背景: 打撃やカメラ揺れで小さな角度変化を付けたい。
  - 目的: ±1〜2°の回転揺れを時間式で提供する。
  - アプローチ: `rotate` フィルタに `deg2rad(amplitude * sin(...))` を埋め込み、減衰付きサイン波を適用する。
  - 検証: 0.3 秒の回転揺れがエイリアスなく再生され、中心ズレが発生しないこと。
  - 備考: 高速回転時は `tblend` などのブラーをオプション提供。

- **アニメーションプリセット参照 (YAML 一発指定)**
  - 背景: 頻出動きを毎回式で書くのは非効率。
  - 目的: よく使う動きをプリセット参照で呼び出し、パラメータだけ上書きできるようにする。
  - アプローチ: `anim: {preset: pop_in, params: {...}}` を定義し、`config/animation_presets.yml` からテンプレをロードする。
  - 検証: `preset=wiggle` 等の指定で期待通り再生し、欠損時にバリデーションエラーが出ること。
  - 備考: プリセットのバージョン管理を追加して互換性を担保。

## 🎞️ アニメーション効果（個別実装）

- **text:pop_text — テキストのポップアップ登場**
  - 背景: ボイスロゴや字幕強調の初動で使用頻度が高い。
  - 目的: テキストレイヤを `scale_from`→`scale_to` へ滑らかに遷移させ、視線を誘導する。
  - アプローチ: `scale`＋`pad` のフィルタチェーンを構築し、拡大時のカットオフを防ぐ。
  - 検証: 0.3 秒ポップインが破綻なく再生し、縮尺が戻る際もクロップが発生しないこと。
  - 備考: RGBA を保つため `format=rgba` を前段に挿入。

- **screen:zoom_screen — 画面全体のゆっくりズーム**
  - 背景: シーン転換や緊張感演出に多用される。
  - 目的: 最終ストリームを脈動させ、中心へ視線を誘導する。
  - アプローチ: `FilterSnippet` に `scale` と `pad` を含むチェーンを持たせ、`scale_from/scale_to` を中心値と振幅に分解する。
  - 検証: 10 秒のデモで 1.0→1.1→1.0 の往復ズームがエッジ破綻なく動くこと。

- **char:scale_char — 立ち絵のぽよん拡縮**
  - 背景: リアクションや感情表現で体全体の弾性を付けたい。
  - 目的: キャラクターレイヤにスケールアニメを適用して弾む動きを表現する。
  - アプローチ: `scale` フィルタを返す `FilterSnippet` を作り、中心保持のための `pad` を自動計算する。
  - 検証: 立ち絵デモで 1.0±0.05 の弾みが自然に再生されること。

- **bg:shake_bg — 背景の揺れ**
  - 背景: キャラクターを固定しつつカメラ振動感を演出したい。
  - 目的: 背景ストリームのみを揺らして没入感を高める。
  - アプローチ: 背景用 `FilterSnippet` を作り、合成前に `translate` 式を適用する分岐を追加する。
  - 検証: 背景のみが揺れ、立ち絵との整合が保たれること。

- **text:shake_text — テキストの震え**
  - 背景: 注意喚起字幕や強調語で震え演出を使いたい。
  - 目的: テキストレイヤの `x/y` を独立位相で変調し警告感を付与する。
  - アプローチ: `char:shake_char` ロジックを流用しつつ、字幕枠外にはみ出さないよう `pad_needed` を調整する。
  - 検証: 1 秒の震えでテキストが枠を越えず、リズムが安定していること。

- **screen:bounce_screen — 画面全体のバウンド**
  - 背景: 着地や衝撃シーンで画面全体を揺らしたい。
  - 目的: `abs(sin)` と指数減衰を組み合わせ、画面全体の垂直動作を実現する。
  - アプローチ: 最終ストリームの `y` 座標式に減衰関数を埋め込み、`eof_action=pass` を指定して尺終端を滑らかにする。
  - 検証: バウンド後に画面が静止し、フェードアウト時に破綻しないこと。

- **char:spin_char — 立ち絵の回転**
  - 背景: ギャグや驚きでキャラを回転させたいシチュエーションがある。
  - 目的: キャラクターレイヤに `rotate` を適用しつつ中心座標を保持する。
  - アプローチ: `FilterSnippet.filter_chain` に `rotate=angle='...'` を追加し、度数→ラジアン変換ユーティリティを用意する。
  - 検証: 360° 回転デモで中心がズレず、四隅がクロップされないこと。

- **screen:spin_screen — 画面全体の回転**
  - 背景: コミカル演出やトランジションで画面全体を回転させたい。
  - 目的: 最終合成後に `rotate` を適用し、出力枠を自動調整する。
  - アプローチ: 後段フィルタチェーンに回転ブロックを挿入し、`rotw/roth` を利用してフレームを拡張する。
  - 検証: 180° 回転でも黒帯・クロップが発生しないこと。

- **text:spin_text — テキストの回転**
  - 背景: テロップのアクセントとして回転を付けたい。
  - 目的: テキストレイヤの回転を制御し、登場や強調に合わせた角度調整を行う。
  - アプローチ: `char:spin_char` 実装を共用しつつ、テキスト固有のアルファ保持のため `format=rgba` を前段に挟む。
  - 検証: 45° 回転テロップがエッジ破綻なく描画されること。

- **char:tilt_char — 立ち絵の傾き固定**
  - 背景: 感情表現で立ち絵を一定角度で固定したいケースがある。
  - 目的: `rotate` の角度を固定値で出力し、傾いた立ち絵を維持する。
  - アプローチ: `resolve` で `amplitude` を角度として扱い、時間依存を排除した `rotate` を適用する。
  - 検証: 傾き固定中に口パク等の差分を適用しても位置ズレが起きないこと。

- **bg:slide_bg — 背景の水平スライド**
  - 背景: シーンに動きを与える補助演出が欲しい。
  - 目的: 直線またはサイン波で背景の `x` 座標を変化させ、パララックス風の動きを付ける。
  - アプローチ: `overlay` の `x` 式に時間式を設定し、ループ時のラップをオプションで制御する。
  - 検証: 10 秒ループで違和感なく往復またはラップすること。

- **bg:spin_bg — 背景の回転**
  - 背景: 特殊演出やトランジション時に背景だけ回転させたい。
  - 目的: 背景ストリームへの `rotate` 適用と空隙処理を整備する。
  - アプローチ: 背景前処理チェーンに回転フィルタを追加し、`pad/crop` で空隙を制御する。
  - 検証: 回転時に黒みが出ず、背景と前景の境界が破綻しないこと。

## 🎨 演出テンプレ & メディア拡張

- **マスク／マット・カスタムワイプ**
  - 背景: 形状に沿った表示やロゴワイプの需要がある。
  - 目的: マスク PNG やマット合成を簡単に適用できるようにする。
  - アプローチ: `fg_overlays[*].mask` や `transitions[*].wipe` を追加し、`alphamerge` や `colorkey` を組み合わせる。
  - 検証: カスタム形状での合成とワイプが崩れなく動作すること。

- **ローワーサード／テロップテンプレ**
  - 背景: 名前帯・解説帯を素早く統一デザインで出したい。
  - 目的: テンプレ＋簡易 API で再利用性を高める。
  - アプローチ: 複数テンプレを同梱し、テキスト／色／位置をパラメータ化。入退場アニメもプリセット化する。
  - 検証: デモ台本で統一感あるローワーサードが適用されること。

- **ピクチャー・イン・ピクチャー（PIP）**
  - 背景: 解説やリアクション用に小画面表示を多用したい。
  - 目的: 角丸・影・枠付きの PIP を簡潔に指定できるようにする。
  - アプローチ: `pip: {src, rect, radius, shadow, border}` スキーマを追加し、 filter_complex で枠と影を合成する。
  - 検証: 設定パラメータが反映され、余白が崩れないこと。

- **カラオケ風字幕（進行ハイライト）**
  - 背景: 読み上げ進行に同期したハイライトが欲しい。
  - 目的: 語・モーラ単位で進行率をハイライト表示する。
  - アプローチ: タイムスタンプに合わせて分割 PNG／マスク、または `subtitles` フィルタを生成する。
  - 検証: 音声とハイライトの誤差が 100ms 未満で収まること。

- **パーティクル（雨／雪／キラ）プリセット**
  - 背景: 手軽に演出を強化したいニーズがある。
  - 目的: 軽量素材や手続きで雨・雪・キラ演出を提供する。
  - アプローチ: `effects[]` に `particles: {type, density, speed, color}` を追加し、既存素材のタイリングと色調整をプリセット化する。
  - 検証: 種別ごとの見た目が安定し、レンダリング負荷が許容範囲に収まること。

- **BGM ビート検出と自動カット合わせ**
  - 背景: 音楽の拍にカットや台詞を寄せたい。
  - 目的: テンポ感と一体感を向上させる自動カット合わせを提供する。
  - アプローチ: librosa 等でビート／オンセットを抽出し、台詞開始時刻を補正する。
  - 検証: クリックデバッグと視聴で自然な一致を確認する。

## ⚙️ パイプライン & 生産性向上

- **GPU オーバーレイ安定化とフォールバック**
  - 背景: CUDA/OpenCL が検出されてもスモーク NG で CPU fallback になるケースが多い。
  - 目的: 安定性を保ちつつ GPU overlay を実運用化し、失敗時はクリップ単位で安全にフォールバックする。
  - アプローチ: クリップごとの成功／失敗を記録し、自動で CPU リトライ。OpenCL は `allow_opencl_overlay_in_cpu_mode` で制御し、CUDA は実験フラグ経由で有効化する。
  - 検証: GPU 有効時に VideoPhase の所要が 30% 以上短縮し、失敗しても CPU で再実行され完走すること。

- **シーンベース生成スキップ条件の厳密化**
  - 背景: 静的オーバーレイが無いのにベース生成が走り無駄な前処理になる。
  - 目的: ベース生成を適切にスキップし、クリップ処理だけで完了できるようにする。
  - アプローチ: 静的レイヤ数と行数を評価し、条件未満なら背景の正規化結果を各行へ伝搬する。
  - 検証: 対象シーンでベース生成の所要が 0 になり、品質が同等であること。

- **立ち絵シーン前合成（ボディ固定＋差分差し替え）**
  - 背景: 毎行フル PNG を overlay し直すため最遅クリップが 9.6s まで伸びている。
  - 目的: ボディをシーン先頭で合成し、行ごとは口／目の差分だけ overlay して速度を向上する。
  - アプローチ: 属性が不変な区間を検出し、ボディをベース化。FaceOverlayCache 済み差分のみ行ごとに重ねる。
  - 検証: 同シーンのクリップ時間が 30〜50% 短縮し、位置ズレが起きないこと。

- **ハードウェアフィルタ再有効化ヒューリスティクス**
  - 背景: 一度失敗するとプロセス全体が CPU モードに固定されやすい。
  - 目的: 安定性を保ちながら、成功が続いたら HW 経路へ自動復帰させる。
  - アプローチ: 失敗後は CPU でリトライしつつ裏で短いフィルタグラフを再テストし、N 回成功で復帰させる。
  - 検証: 不安定環境でも GPU スケール／overlay が継続的に再有効化され、全体時間が改善すること。

- **ドキュメントと診断ログの整備**
  - 背景: README と実装の既定値が一致せず混乱が発生している。
  - 目的: 設定値の整合を取りつつ診断ログを強化し、環境差異の切り分けを容易にする。
  - アプローチ: README/AI_README を実装に合わせて修正し、FilterDiag へ有効／無効理由のメッセージを追加する。
  - 検証: 設定だけで挙動を再現でき、問い合わせなく原因切り分けができること。

- **VOICEVOX 音声合成の並列化**
  - 背景: 大規模台本では音声生成がボトルネックになりやすい。
  - 目的: スループット向上とレート制限回避を図る。
  - アプローチ: `asyncio.Semaphore` で全体／話者別上限を設け、タイムアウトとリトライを調整する。
  - 検証: 大規模台本で処理時間が短縮し、エラー率が増えないこと。

- **SRT / WebVTT の入出力**
  - 背景: 外部ツールとの互換性が求められている。
  - 目的: SRT/ASS/VTT のインポート・エクスポートをサポートする。
  - アプローチ: `Timeline` のシリアライズ／デシリアライズを拡張し、CLI オプションで形式を指定できるようにする。
  - 検証: 既存ツールとの往復で差分が最小限に収まること。

- **プレビュー高速レンダリングモード**
  - 背景: 演出調整時の反復を高速化したい。
  - 目的: 低解像度・低ビットレートでのクイック出力を提供する。
  - アプローチ: `--preview` オプションで VideoParams を縮小し、字幕 PNG キャッシュを共用、CRF/ビットレートを軽量化する。
  - 検証: 所要時間が大幅に短縮され、プレビュー品質として許容範囲であること。

- **背景除去／クロマキー簡易対応**
  - 背景: グリーンバックや静止画の除去需要がある。
  - 目的: 色キーや差分合成を手軽に適用できるようにする。
  - アプローチ: `fg_overlays[*].chroma` を拡張し、`colorkey/chromakey` と塗り足し・エッジブラー設定を提供する。
  - 検証: 境界ノイズや色抜けが許容範囲に収まること。

- **YAML スキーマ拡張（assets 辞書・字幕スタイル）**
  - 背景: パス直書きや冗長なスタイル指定が増えている。
  - 目的: スキーマを簡素化し可読性を高める。
  - アプローチ: `assets: {logo: path, ...}` や `subtitle.styles[]` のテンプレを導入し、`script_loader` で解決する。
  - 検証: 台本の重複が減り、バリデーションが機能すること。

- **自動ポーズ／句読点ルール**
  - 背景: 句読点で自然な間を入れたい。
  - 目的: 音声の自然なテンポを実現する。
  - アプローチ: テキスト整形でポーズを挿入し、音声生成と同期させる。
  - 検証: 聴感上の自然さが向上し、タイムライン整合が取れること。

- **サムネイル／チャプター自動生成**
  - 背景: 公開準備を効率化したい。
  - 目的: キーシーン静止画と YouTube チャプターを自動生成する。
  - アプローチ: Scene 境界と台詞見出しから ffmpeg でサムネ抽出し、MD/TXT でチャプター出力する。
  - 検証: 生成された時刻と内容が妥当であること。

- **プロジェクトテンプレ／テーマ**
  - 背景: 新規プロジェクト立ち上げを簡略化したい。
  - 目的: スタイル・構成の再利用性を高めるテンプレートを提供する。
  - アプローチ: `templates/` に複数テーマの雛形を整備し、CLI スキャフォールドを追加する。
  - 検証: 雛形からプロジェクトを生成し、README チュートリアルどおりに実行できること。
